<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>사원관리</title>
  <link rel="stylesheet" href="assets/nav.css">
  <style>
    :root{ --bd:#e5e7eb; --fg:#111; --mut:#6b7280; --bg:#f5f6f8; --card:#fff; --primary:#2563eb; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;padding-top:60px}
    .container{max-width:1400px;margin:16px auto;padding:0 12px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:20px;margin-bottom:16px}
    h2{margin:0 0 12px;font-size:20px;font-weight:800}
    h3{margin:0 0 12px;font-size:16px;font-weight:700}
    .form-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
    @media(max-width:1000px){.form-grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:600px){.form-grid{grid-template-columns:1fr}}
    .form-row{display:flex;flex-direction:column;gap:4px}
    .inp,.sel{height:38px;padding:0 12px;border:1px solid var(--bd);border-radius:6px;font-size:13px;background:#fff;width:100%}
    .btn{height:32px;padding:0 12px;border:1px solid var(--bd);border-radius:6px;font-size:12px;background:#fff;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.danger{background:#ef4444;border-color:#ef4444;color:#fff}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
    .table-wrap{border:1px solid var(--bd);border-radius:8px;overflow:auto}
    table{width:100%;border-collapse:collapse;background:#fff;font-size:13px}
    thead{background:#f8f9fa;position:sticky;top:0}
    th,td{padding:10px;border-bottom:1px solid #f1f3f5;text-align:center;white-space:nowrap}
    .align-left{text-align:left}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:11px;font-weight:700}
    .badge.pending{background:#fef3c7;color:#92400e}
    .badge.active{background:#d1fae5;color:#065f46}
    .badge.inactive{background:#fee2e2;color:#991b1b}
    .badge.leave{background:#fef3c7;color:#92400e}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:100;padding:20px}
    .modal.show{display:flex}
    .modal-content{background:#fff;border-radius:12px;width:min(700px,92%);padding:20px;box-shadow:0 8px 32px rgba(0,0,0,.3);max-height:90vh;overflow:auto}
    .perm-box{border:1px solid var(--bd);border-radius:8px;padding:10px}
    .perm-group{display:flex;flex-wrap:wrap;gap:10px}
    .perm-item{display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;border-radius:6px;padding:6px 10px;background:#fff;font-size:12px}
  </style>
</head>
<body>
  <header class="fixed-header"></header>

  <main class="container">
    <h2>사원 관리</h2>

    <!-- 승인 대기 목록 -->
    <section class="card" data-perm="employee.manage">
      <h3>승인 대기</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>신청일</th><th>ID</th><th class="align-left">이름</th><th>부서</th><th class="align-left">이메일</th><th>상태</th><th>처리</th>
            </tr>
          </thead>
          <tbody id="tbodyPending"></tbody>
        </table>
      </div>
    </section>

    <!-- 사원 등록 -->
    <section class="card" data-perm="employee.manage">
      <h3>사원 등록</h3>
      <div class="form-grid">
        <div class="form-row"><label>사원번호 *</label><input id="empNo" class="inp" placeholder="예: EMP001"></div>
        <div class="form-row"><label>이름 *</label><input id="empName" class="inp"></div>
        <div class="form-row"><label>부서 *</label>
          <select id="empDept" class="sel"><option value="">-- 선택 --</option><option>생산부</option><option>품질관리부</option><option>영업부</option><option>관리부</option><option>연구개발부</option><option>물류부</option></select>
        </div>
        <div class="form-row"><label>직급 *</label>
          <select id="empPosition" class="sel"><option value="">-- 선택 --</option><option>사원</option><option>대리</option><option>과장</option><option>차장</option><option>부장</option><option>이사</option></select>
        </div>
        <div class="form-row"><label>연락처</label><input id="empPhone" class="inp" placeholder="010-1234-5678"></div>
        <div class="form-row"><label>이메일</label><input id="empEmail" class="inp" type="email" placeholder="example@sepnp.com"></div>
        <div class="form-row"><label>입사일 *</label><input id="empJoinDate" class="inp" type="date"></div>
        <div class="form-row"><label>상태</label><select id="empStatus" class="sel"><option value="active">재직</option><option value="leave">휴직</option><option value="inactive">퇴사</option></select></div>
        <div class="form-row"><label>권한 역할</label>
          <select id="empRole" class="sel"><option value="viewer">Viewer</option><option value="staff">Staff</option><option value="manager">Manager</option><option value="admin">Admin</option></select>
        </div>
        <div class="form-row" style="grid-column:1/-1">
          <label>세부 권한</label>
          <div class="perm-box">
            <div class="perm-group" id="empPermGroup">
              <label class="perm-item"><input type="checkbox" name="empPerm" value="employee.view"> 직원 조회</label>
              <label class="perm-item"><input type="checkbox" name="empPerm" value="employee.manage"> 직원 등록/수정/삭제</label>
              <label class="perm-item"><input type="checkbox" name="empPerm" value="employee.export"> 직원 CSV 내보내기</label>
              <label class="perm-item"><input type="checkbox" name="empPerm" value="dispatch.view"> 배차 조회</label>
              <label class="perm-item"><input type="checkbox" name="empPerm" value="dispatch.create"> 배차 등록</label>
              <label class="perm-item"><input type="checkbox" name="empPerm" value="dispatch.edit"> 배차 수정</label>
              <label class="perm-item"><input type="checkbox" name="empPerm" value="dispatch.cancel"> 배차 취소</label>
              <label class="perm-item"><input type="checkbox" name="empPerm" value="dispatch.delete"> 배차 삭제</label>
              <label class="perm-item"><input type="checkbox" name="empPerm" value="sales.view"> 매출현황 조회</label>
              <label class="perm-item"><input type="checkbox" name="empPerm" value="inventory.view"> 재고 조회</label>
              <label class="perm-item"><input type="checkbox" name="empPerm" value="quotation.view"> 견적서 조회</label>
              <label class="perm-item"><input type="checkbox" name="empPerm" value="product.view"> 제품 조회</label>
              <label class="perm-item"><input type="checkbox" name="empPerm" value="order.view"> 주문 조회</label>
              <label class="perm-item"><input type="checkbox" name="empPerm" value="plan.view"> 계획표 조회</label>
              <label class="perm-item"><input type="checkbox" name="empPerm" value="assign.view"> 배정 조회</label>
              <label class="perm-item"><input type="checkbox" name="empPerm" value="work.view"> 작업 조회</label>
              <label class="perm-item"><input type="checkbox" name="empPerm" value="assign.print"> 인쇄 작업 배정</label>
              <label class="perm-item"><input type="checkbox" name="empPerm" value="assign.thomson"> 톰슨 작업 배정</label>
              <label class="perm-item"><input type="checkbox" name="empPerm" value="assign.coating"> 코팅 작업 배정</label>
              <label class="perm-item"><input type="checkbox" name="empPerm" value="assign.adhesive"> 접착 작업 배정</label>
              <label class="perm-item"><input type="checkbox" name="empPerm" value="assign.lamination"> 합지 작업 배정</label>
            </div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button class="btn" type="button" id="btnEmpPermPreset">역할 프리셋</button>
              <button class="btn" type="button" id="btnEmpPermClear">모두 해제</button>
            </div>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" onclick="resetForm()">초기화</button>
        <button class="btn primary" onclick="registerEmployee()">사원 등록</button>
      </div>
    </section>

    <!-- 사원 목록 -->
    <section class="card">
      <h3>사원 목록</h3>
      <div class="toolbar">
        <input id="searchQuery" class="inp" style="flex:1;min-width:200px" placeholder="이름, 사번, 부서 검색">
        <select id="filterDept" class="sel" style="width:130px"><option value="">전체 부서</option><option>생산부</option><option>품질관리부</option><option>영업부</option><option>관리부</option><option>연구개발부</option><option>물류부</option></select>
        <select id="filterStatus" class="sel" style="width:110px"><option value="">전체 상태</option><option value="active">재직</option><option value="leave">휴직</option><option value="inactive">퇴사</option></select>
        <button class="btn" onclick="searchEmployee()">검색</button>
        <button class="btn" data-perm="employee.export" onclick="exportCSV()">CSV 내보내기</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>사번</th><th class="align-left">이름</th><th>ID</th><th>부서</th><th>직급</th><th>연락처</th><th class="align-left">이메일</th><th>입사일</th><th>상태</th><th>관리</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- 승인 모달 -->
  <div id="approveModal" class="modal">
    <div class="modal-content">
      <h3>가입신청 승인 및 권한부여</h3>
      <div class="form-grid">
        <div class="form-row"><label>ID</label><input id="apprUsername" class="inp" readonly></div>
        <div class="form-row"><label>이름</label><input id="apprName" class="inp"></div>
        <div class="form-row"><label>부서</label>
          <select id="apprDept" class="sel"><option>생산부</option><option>품질관리부</option><option>영업부</option><option>관리부</option><option>연구개발부</option><option>물류부</option></select>
        </div>
        <div class="form-row"><label>사원번호 *</label><input id="apprEmpNo" class="inp" placeholder="예: EMP001"></div>
        <div class="form-row"><label>직급</label>
          <select id="apprPosition" class="sel"><option>사원</option><option>대리</option><option>과장</option><option>차장</option><option>부장</option><option>이사</option></select>
        </div>
        <div class="form-row"><label>이메일</label><input id="apprEmail" class="inp" type="email"></div>
        <div class="form-row"><label>연락처</label><input id="apprPhone" class="inp"></div>
        <div class="form-row"><label>입사일</label><input id="apprJoinDate" class="inp" type="date"></div>
        <div class="form-row"><label>역할</label>
          <select id="apprRole" class="sel"><option value="viewer">Viewer</option><option value="staff">Staff</option><option value="manager">Manager</option><option value="admin">Admin</option></select>
        </div>
        <div class="form-row" style="grid-column:1/-1">
          <label>세부 권한</label>
          <div class="perm-box">
            <div class="perm-group" id="apprPermGroup">
              <label class="perm-item"><input type="checkbox" name="apprPerm" value="employee.view"> 직원 조회</label>
              <label class="perm-item"><input type="checkbox" name="apprPerm" value="employee.manage"> 직원 등록/수정/삭제</label>
              <label class="perm-item"><input type="checkbox" name="apprPerm" value="employee.export"> 직원 CSV 내보내기</label>
              <label class="perm-item"><input type="checkbox" name="apprPerm" value="dispatch.view"> 배차 조회</label>
              <label class="perm-item"><input type="checkbox" name="apprPerm" value="dispatch.create"> 배차 등록</label>
              <label class="perm-item"><input type="checkbox" name="apprPerm" value="dispatch.edit"> 배차 수정</label>
              <label class="perm-item"><input type="checkbox" name="apprPerm" value="dispatch.cancel"> 배차 취소</label>
              <label class="perm-item"><input type="checkbox" name="apprPerm" value="dispatch.delete"> 배차 삭제</label>
              <label class="perm-item"><input type="checkbox" name="apprPerm" value="sales.view"> 매출현황 조회</label>
              <label class="perm-item"><input type="checkbox" name="apprPerm" value="inventory.view"> 재고 조회</label>
              <label class="perm-item"><input type="checkbox" name="apprPerm" value="quotation.view"> 견적서 조회</label>
              <label class="perm-item"><input type="checkbox" name="apprPerm" value="product.view"> 제품 조회</label>
              <label class="perm-item"><input type="checkbox" name="apprPerm" value="order.view"> 주문 조회</label>
              <label class="perm-item"><input type="checkbox" name="apprPerm" value="plan.view"> 계획표 조회</label>
              <label class="perm-item"><input type="checkbox" name="apprPerm" value="assign.view"> 배정 조회</label>
              <label class="perm-item"><input type="checkbox" name="apprPerm" value="work.view"> 작업 조회</label>
              <label class="perm-item"><input type="checkbox" name="apprPerm" value="assign.print"> 인쇄 작업 배정</label>
              <label class="perm-item"><input type="checkbox" name="apprPerm" value="assign.thomson"> 톰슨 작업 배정</label>
              <label class="perm-item"><input type="checkbox" name="apprPerm" value="assign.coating"> 코팅 작업 배정</label>
              <label class="perm-item"><input type="checkbox" name="apprPerm" value="assign.adhesive"> 접착 작업 배정</label>
              <label class="perm-item"><input type="checkbox" name="apprPerm" value="assign.lamination"> 합지 작업 배정</label>
            </div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button class="btn" type="button" id="btnApprPermPreset">역할 프리셋</button>
              <button class="btn" type="button" id="btnApprPermClear">모두 해제</button>
            </div>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" onclick="closeApprove()">취소</button>
        <button class="btn primary" data-perm="employee.manage" onclick="approveNow()">승인</button>
      </div>
    </div>
  </div>

  <!-- 사원 상세/수정 모달 -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <h3>사원 정보 수정</h3>
      <div class="form-grid">
        <div class="form-row"><label>사원번호</label><input id="detailEmpNo" class="inp" readonly style="background:#f9fafb"></div>
        <div class="form-row"><label>ID</label><input id="detailUsername" class="inp" readonly style="background:#f9fafb"></div>
        <div class="form-row"><label>이름</label><input id="detailName" class="inp"></div>
        <div class="form-row"><label>부서</label>
          <select id="detailDept" class="sel"><option>생산부</option><option>품질관리부</option><option>영업부</option><option>관리부</option><option>연구개발부</option><option>물류부</option></select>
        </div>
        <div class="form-row"><label>직급</label>
          <select id="detailPosition" class="sel"><option>사원</option><option>대리</option><option>과장</option><option>차장</option><option>부장</option><option>이사</option></select>
        </div>
        <div class="form-row"><label>연락처</label><input id="detailPhone" class="inp"></div>
        <div class="form-row"><label>이메일</label><input id="detailEmail" class="inp" type="email"></div>
        <div class="form-row"><label>입사일</label><input id="detailJoinDate" class="inp" type="date"></div>
        <div class="form-row"><label>상태</label>
          <select id="detailStatus" class="sel"><option value="active">재직</option><option value="leave">휴직</option><option value="inactive">퇴사</option></select>
        </div>
        <div class="form-row"><label>역할</label>
          <select id="detailRole" class="sel"><option value="viewer">Viewer</option><option value="staff">Staff</option><option value="manager">Manager</option><option value="admin">Admin</option></select>
        </div>
        <div class="form-row" style="grid-column:1/-1">
          <label>세부 권한</label>
          <div class="perm-box">
            <div class="perm-group" id="detailPermGroup">
              <label class="perm-item"><input type="checkbox" name="detailPerm" value="employee.view"> 직원 조회</label>
              <label class="perm-item"><input type="checkbox" name="detailPerm" value="employee.manage"> 직원 등록/수정/삭제</label>
              <label class="perm-item"><input type="checkbox" name="detailPerm" value="employee.export"> 직원 CSV 내보내기</label>
              <label class="perm-item"><input type="checkbox" name="detailPerm" value="dispatch.view"> 배차 조회</label>
              <label class="perm-item"><input type="checkbox" name="detailPerm" value="dispatch.create"> 배차 등록</label>
              <label class="perm-item"><input type="checkbox" name="detailPerm" value="dispatch.edit"> 배차 수정</label>
              <label class="perm-item"><input type="checkbox" name="detailPerm" value="dispatch.cancel"> 배차 취소</label>
              <label class="perm-item"><input type="checkbox" name="detailPerm" value="dispatch.delete"> 배차 삭제</label>
              <label class="perm-item"><input type="checkbox" name="detailPerm" value="sales.view"> 매출현황 조회</label>
              <label class="perm-item"><input type="checkbox" name="detailPerm" value="inventory.view"> 재고 조회</label>
              <label class="perm-item"><input type="checkbox" name="detailPerm" value="quotation.view"> 견적서 조회</label>
              <label class="perm-item"><input type="checkbox" name="detailPerm" value="product.view"> 제품 조회</label>
              <label class="perm-item"><input type="checkbox" name="detailPerm" value="order.view"> 주문 조회</label>
              <label class="perm-item"><input type="checkbox" name="detailPerm" value="plan.view"> 계획표 조회</label>
              <label class="perm-item"><input type="checkbox" name="detailPerm" value="assign.view"> 배정 조회</label>
              <label class="perm-item"><input type="checkbox" name="detailPerm" value="work.view"> 작업 조회</label>
              <label class="perm-item"><input type="checkbox" name="detailPerm" value="assign.print"> 인쇄 작업 배정</label>
              <label class="perm-item"><input type="checkbox" name="detailPerm" value="assign.thomson"> 톰슨 작업 배정</label>
              <label class="perm-item"><input type="checkbox" name="detailPerm" value="assign.coating"> 코팅 작업 배정</label>
              <label class="perm-item"><input type="checkbox" name="detailPerm" value="assign.adhesive"> 접착 작업 배정</label>
              <label class="perm-item"><input type="checkbox" name="detailPerm" value="assign.lamination"> 합지 작업 배정</label>
            </div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button class="btn" type="button" id="btnDetailPermPreset">역할 프리셋</button>
              <button class="btn" type="button" id="btnDetailPermClear">모두 해제</button>
            </div>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn danger" data-perm="employee.manage" onclick="deleteEmployee()">삭제</button>
        <button class="btn" onclick="closeDetail()">취소</button>
        <button class="btn primary" data-perm="employee.manage" onclick="saveDetail()">저장</button>
      </div>
    </div>
  </div>

  <script src="assets/perm.js"></script>
  <script src="assets/auth.js"></script>
  <script src="assets/nav.js"></script>
  <script>
    const KEY_EMPLOYEES = 'sepnp_employees';
    const KEY_PENDING = 'sepnp_pending_employees';
    const $ = s => document.querySelector(s);
    let employees = [];
    let pending = [];
    let approveTarget = null;
    let detailTarget = null; // 수정 대상 사원

    function loadAll(){
      employees = JSON.parse(localStorage.getItem(KEY_EMPLOYEES)||'[]');
      pending = JSON.parse(localStorage.getItem(KEY_PENDING)||'[]');
      renderEmployees();
      renderPending();
      Permissions.applyGates();
    }

    function saveEmployees(){ localStorage.setItem(KEY_EMPLOYEES, JSON.stringify(employees)); }
    function savePending(){ localStorage.setItem(KEY_PENDING, JSON.stringify(pending)); }

    function renderPending(){
      const tb = $('#tbodyPending');
      if(!pending.length){
        tb.innerHTML = '<tr><td colspan="7" style="padding:24px;color:#6b7280">승인 대기 중인 신청이 없습니다.</td></tr>';
        return;
      }
      tb.innerHTML = pending.map(p=>`
        <tr>
          <td>${(p.createdAt||'').slice(0,10)}</td>
          <td>${p.username}</td>
          <td class="align-left"><strong>${p.name}</strong></td>
          <td>${p.dept}</td>
          <td class="align-left">${p.email||'-'}</td>
          <td><span class="badge pending">대기</span></td>
          <td>
            <button class="btn primary" data-perm="employee.manage" onclick="openApprove('${p.id}')">승인</button>
            <button class="btn danger" data-perm="employee.manage" onclick="rejectPending('${p.id}')">반려</button>
          </td>
        </tr>
      `).join('');
      Permissions.applyGates(document);
    }

    function openApprove(id){
      const p = pending.find(x=>x.id===id);
      if(!p) return;
      approveTarget = p;
      $('#apprUsername').value = p.username;
      $('#apprName').value = p.name;
      $('#apprDept').value = p.dept;
      $('#apprEmail').value = p.email||'';
      $('#apprPhone').value = '';
      $('#apprEmpNo').value = '';
      $('#apprPosition').value = '사원';
      $('#apprJoinDate').valueAsDate = new Date();
      $('#apprRole').value = 'viewer';
      document.querySelectorAll("input[name='apprPerm']").forEach(b=>b.checked=false);
      $('#approveModal').classList.add('show');
      Permissions.applyGates($('#approveModal'));
    }
    function closeApprove(){ approveTarget = null; $('#approveModal').classList.remove('show'); }

    function getCheckedPerms(nameAttr){
      return Array.from(document.querySelectorAll(`input[name='${nameAttr}']:checked`)).map(x=>x.value);
    }

    function approveNow(){
      if(!Permissions.has('employee.manage')){ alert('권한이 없습니다.'); return; }
      if(!approveTarget){ return; }
      const empNo = $('#apprEmpNo').value.trim();
      if(!empNo){ alert('사원번호를 입력하세요.'); return; }
      if(employees.some(e=>e.empNo===empNo)){ alert('이미 존재하는 사원번호입니다.'); return; }

      const emp = {
        id: 'emp_'+Date.now(),
        empNo,
        username: approveTarget.username,
        passwordHash: approveTarget.passwordHash,
        name: $('#apprName').value.trim(),
        dept: $('#apprDept').value,
        position: $('#apprPosition').value,
        phone: $('#apprPhone').value.trim(),
        email: $('#apprEmail').value.trim(),
        joinDate: $('#apprJoinDate').value,
        status: 'active',
        role: $('#apprRole').value,
        perms: getCheckedPerms('apprPerm'),
        createdAt: new Date().toISOString()
      };

      employees.push(emp);
      pending = pending.filter(p=>p.id!==approveTarget.id);
      saveEmployees(); savePending();
      closeApprove();
      renderEmployees(); renderPending();
      alert('승인 완료: 계정이 활성화되었습니다.');
    }

    function rejectPending(id){
      if(!Permissions.has('employee.manage')){ alert('권한이 없습니다.'); return; }
      if(!confirm('이 가입신청을 반려하시겠습니까?')) return;
      pending = pending.filter(p=>p.id!==id);
      savePending(); renderPending();
      alert('반려 처리되었습니다.');
    }

    function resetForm(){
      $('#empNo').value=''; $('#empName').value=''; $('#empDept').value='';
      $('#empPosition').value=''; $('#empPhone').value=''; $('#empEmail').value='';
      $('#empJoinDate').value=''; $('#empStatus').value='active';
      $('#empRole').value='viewer'; document.querySelectorAll("input[name='empPerm']").forEach(b=>b.checked=false);
    }

    function registerEmployee(){
      if(!Permissions.has('employee.manage')){ alert('권한이 없습니다.'); return; }
      const empNo = $('#empNo').value.trim();
      const name = $('#empName').value.trim();
      const dept = $('#empDept').value;
      const position = $('#empPosition').value;
      const phone = $('#empPhone').value.trim();
      const email = $('#empEmail').value.trim();
      const joinDate = $('#empJoinDate').value;
      const status = $('#empStatus').value;
      const role = $('#empRole').value;
      const perms = getCheckedPerms('empPerm');
      if(!empNo || !name || !dept || !position || !joinDate){ alert('필수 항목을 입력하세요.'); return; }
      if(employees.find(e=>e.empNo===empNo)){ alert('이미 등록된 사번입니다.'); return; }

      employees.push({ id:'emp_'+Date.now(), empNo, name, dept, position, phone, email, joinDate, status, role, perms, createdAt:new Date().toISOString() });
      saveEmployees(); renderEmployees(); resetForm(); alert('사원이 등록되었습니다.');
    }

    function renderEmployees(){
      const query = ($('#searchQuery')?.value||'').toLowerCase();
      const filterDept = $('#filterDept')?.value || '';
      const filterStatus = $('#filterStatus')?.value || '';
      const list = employees.filter(e=>{
        const q = !query || e.empNo?.toLowerCase().includes(query) || e.name?.toLowerCase().includes(query) || e.dept?.toLowerCase().includes(query);
        const d = !filterDept || e.dept===filterDept;
        const s = !filterStatus || e.status===filterStatus;
        return q && d && s;
      });

      const tbody = $('#tbody');
      if(!tbody) return;
      if(!list.length){
        tbody.innerHTML = '<tr><td colspan="10" style="padding:24px;color:#6b7280">사원이 없습니다.</td></tr>';
        return;
      }
      tbody.innerHTML = list.map(e=>{
        const statusBadge = e.status==='active'?'active':(e.status==='leave'?'leave':'inactive');
        const statusText = e.status==='active'?'재직':(e.status==='leave'?'휴직':'퇴사');
        return `
        <tr>
          <td>${e.empNo}</td>
          <td class="align-left"><strong>${e.name}</strong></td>
          <td>${e.username||'-'}</td>
          <td>${e.dept||'-'}</td>
          <td>${e.position||'-'}</td>
          <td>${e.phone||'-'}</td>
          <td class="align-left">${e.email||'-'}</td>
          <td>${e.joinDate||'-'}</td>
          <td><span class="badge ${statusBadge}">${statusText}</span></td>
          <td><button class="btn primary" onclick="openDetail('${e.id}')">상세</button></td>
        </tr>`;
      }).join('');
    }

    function searchEmployee(){ renderEmployees(); }

    function exportCSV(){
      if(!Permissions.has('employee.export')){ alert('권한이 없습니다.'); return; }
      const header = ['사번','이름','ID','부서','직급','연락처','이메일','입사일','상태','역할'];
      const rows = employees.map(e=>[
        e.empNo, e.name, e.username||'', e.dept||'', e.position||'',
        e.phone||'', e.email||'', e.joinDate||'',
        e.status==='active'?'재직':(e.status==='leave'?'휴직':'퇴사'),
        e.role||'viewer'
      ]);
      const csv = [header].concat(rows).map(r=>r.map(v=>`"${v}"`).join(',')).join('\r\n');
      const blob = new Blob(['\ufeff'+csv], {type:'text/csv;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `사원목록_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    }

    // 상세/수정 모달
    function openDetail(id){
      const emp = employees.find(e=>e.id===id);
      if(!emp) return;
      detailTarget = emp;

      $('#detailEmpNo').value = emp.empNo;
      $('#detailUsername').value = emp.username || '';
      $('#detailName').value = emp.name;
      $('#detailDept').value = emp.dept;
      $('#detailPosition').value = emp.position;
      $('#detailPhone').value = emp.phone||'';
      $('#detailEmail').value = emp.email||'';
      $('#detailJoinDate').value = emp.joinDate;
      $('#detailStatus').value = emp.status;
      $('#detailRole').value = emp.role||'viewer';

      // 권한 체크
      document.querySelectorAll("input[name='detailPerm']").forEach(b=>b.checked=false);
      const perms = Array.isArray(emp.perms) && emp.perms.length
        ? emp.perms
        : (Permissions.ROLE_PRESETS[emp.role||'viewer'] || []);
      if(perms.includes('*')){
        document.querySelectorAll("input[name='detailPerm']").forEach(b=>b.checked=true);
      }else{
        perms.forEach(p=>{
          const el = Array.from(document.querySelectorAll("input[name='detailPerm']")).find(b=>b.value===p);
          if(el) el.checked = true;
        });
      }

      $('#detailModal').classList.add('show');
      Permissions.applyGates($('#detailModal'));
    }

    function closeDetail(){
      detailTarget = null;
      $('#detailModal').classList.remove('show');
    }

    function saveDetail(){
      if(!Permissions.has('employee.manage')){ alert('권한이 없습니다.'); return; }
      if(!detailTarget) return;

      detailTarget.name = $('#detailName').value.trim();
      detailTarget.dept = $('#detailDept').value;
      detailTarget.position = $('#detailPosition').value;
      detailTarget.phone = $('#detailPhone').value.trim();
      detailTarget.email = $('#detailEmail').value.trim();
      detailTarget.joinDate = $('#detailJoinDate').value;
      detailTarget.status = $('#detailStatus').value;
      detailTarget.role = $('#detailRole').value;
      detailTarget.perms = getCheckedPerms('detailPerm');

      saveEmployees();
      renderEmployees();
      closeDetail();
      alert('사원 정보가 수정되었습니다.');
    }

    function deleteEmployee(){
      if(!Permissions.has('employee.manage')){ alert('권한이 없습니다.'); return; }
      if(!detailTarget) return;
      if(!confirm(`${detailTarget.name} 사원을 삭제하시겠습니까?`)) return;

      employees = employees.filter(e=>e.id!==detailTarget.id);
      saveEmployees();
      renderEmployees();
      closeDetail();
      alert('사원이 삭제되었습니다.');
    }

    // 프리셋 버튼
    document.addEventListener('DOMContentLoaded', ()=>{
      if (window.Auth?.ensureDefaultAdmin) { Auth.ensureDefaultAdmin().then(()=>loadAll()); }
      else { loadAll(); }

      $('#btnEmpPermPreset')?.addEventListener('click', ()=> {
        const role = $('#empRole').value; const preset = Permissions.ROLE_PRESETS[role]||[];
        document.querySelectorAll("input[name='empPerm']").forEach(b=>b.checked = preset.includes('*') || preset.includes(b.value));
      });
      $('#btnEmpPermClear')?.addEventListener('click', ()=> document.querySelectorAll("input[name='empPerm']").forEach(b=>b.checked=false));

      $('#btnApprPermPreset')?.addEventListener('click', ()=> {
        const role = $('#apprRole').value; const preset = Permissions.ROLE_PRESETS[role]||[];
        document.querySelectorAll("input[name='apprPerm']").forEach(b=>b.checked = preset.includes('*') || preset.includes(b.value));
      });
      $('#btnApprPermClear')?.addEventListener('click', ()=> document.querySelectorAll("input[name='apprPerm']").forEach(b=>b.checked=false));

      $('#btnDetailPermPreset')?.addEventListener('click', ()=> {
        const role = $('#detailRole').value; const preset = Permissions.ROLE_PRESETS[role]||[];
        document.querySelectorAll("input[name='detailPerm']").forEach(b=>b.checked = preset.includes('*') || preset.includes(b.value));
      });
      $('#btnDetailPermClear')?.addEventListener('click', ()=> document.querySelectorAll("input[name='detailPerm']").forEach(b=>b.checked=false));

      // 모달 외부 클릭 닫기
      $('#approveModal')?.addEventListener('click', e=>{ if(e.target.id==='approveModal') closeApprove(); });
      $('#detailModal')?.addEventListener('click', e=>{ if(e.target.id==='detailModal') closeDetail(); });

      // 검색 엔터
      $('#searchQuery')?.addEventListener('keydown', e=>{ if(e.key==='Enter') searchEmployee(); });
    });
  </script>
</body>
</html>