<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>인쇄 배정</title>
  <link rel="stylesheet" href="assets/nav.css">
  <style>
    :root{--primary:#2563eb;--border:#e5e7eb;--bg:#f9fafb;--text:#111;--muted:#6b7280}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--text);padding-top:60px}
    .container{max-width:1600px;margin:20px auto;padding:0 16px}
    h2{font-size:20px;margin-bottom:16px}
    .board{display:grid;grid-template-columns:280px 1fr;gap:20px}
    .pool-section,.lanes-section{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px}
    .pool-section h3,.lanes-section h3{font-size:16px;margin-bottom:12px;color:var(--muted)}
    .pool-cards{display:flex;flex-direction:column;gap:10px;min-height:400px}
    .pool-card{padding:12px;background:#fef3c7;border:1px solid #fde047;border-radius:8px;cursor:pointer;transition:all .2s}
    .pool-card:hover{background:#fde047;transform:translateY(-2px)}
    .card-title{font-weight:600;margin-bottom:6px}
    .card-meta{font-size:13px;color:#666}
    .card-meta div{margin-top:4px}
    .lanes-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .lane{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;min-height:300px}
    .lane h4{font-size:14px;margin-bottom:10px;color:var(--muted)}
    .lane-cards{display:flex;flex-direction:column;gap:8px}
    .lane-card{padding:10px;background:#fff;border:1px solid var(--border);border-radius:6px;cursor:move;transition:all .15s}
    .lane-card:hover{box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .lane-card.assigned{background:#dbeafe;border-color:#93c5fd}
    .lane-card.done{background:#d1fae5;border-color:#86efac}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:100}
    .modal.show{display:flex}
    .modal-content{background:#fff;border-radius:12px;padding:24px;width:min(500px,90%);max-height:80vh;overflow:auto}
    .modal-content h3{margin-bottom:16px}
    .modal-content .row{display:grid;grid-template-columns:100px 1fr;gap:10px;margin:10px 0;align-items:center}
    .modal-content .label{font-weight:600;color:var(--muted)}
    .modal-content select,.modal-content input{height:36px;padding:0 10px;border:1px solid var(--border);border-radius:6px;font-size:14px}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:20px}
    .btn{height:36px;padding:0 16px;border:1px solid var(--border);border-radius:6px;background:#fff;cursor:pointer;font-size:14px}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn:hover{opacity:.9}
  </style>
</head>
<body>
  <header class="fixed-header"></header>

  <main class="container">
    <h2>인쇄 배정</h2>
    <div class="board">
      <div class="pool-section">
        <h3>배정 풀 (<span id="poolCount">0</span>)</h3>
        <div class="pool-cards" id="assignPool"></div>
      </div>
      <div class="lanes-section">
        <h3>인쇄기 현황</h3>
        <div class="lanes-grid" id="lanesGrid"></div>
      </div>
    </div>
  </main>

  <div id="assignModal" class="modal">
    <div class="modal-content">
      <h3>배정하기</h3>
      <div id="assignForm"></div>
      <div class="modal-actions">
        <button class="btn" onclick="closeAssignModal()">취소</button>
        <button class="btn primary" onclick="confirmAssign()">배정</button>
      </div>
    </div>
  </div>

  <script src="assets/nav.js"></script>
  <script>
    const NF = new Intl.NumberFormat('ko-KR');
    const esc = s => (s==null?'':String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]));

    const PRESSES = ['1호기','2호기','3호기'];
    let state = { pool: [], lanes: {}, completed: [], history: [] };
    let selectedCard = null;

    function saveState() {
      localStorage.setItem('sepnp_assign_v2', JSON.stringify(state));
    }

    function loadState() {
      const saved = localStorage.getItem('sepnp_assign_v2');
      if (saved) {
        try {
          state = JSON.parse(saved);
          if (!state.pool) state.pool = [];
          if (!state.lanes) state.lanes = {};
          if (!state.completed) state.completed = [];
          if (!state.history) state.history = [];
        } catch (e) {
          console.error('assign state parse error', e);
          state = { pool: [], lanes: {}, completed: [], history: [] };
        }
      } else {
        state = { pool: [], lanes: {}, completed: [], history: [] };
      }

      PRESSES.forEach(p => {
        if (!Array.isArray(state.lanes[p])) state.lanes[p] = [];
      });

      // 주문 → 배정 풀 동기화 (인쇄 공정이 있는 주문만)
      const orders = JSON.parse(localStorage.getItem('sepnp_orders_v1') || '[]');
      orders.forEach(o => {
        if (!o.id) return;
        const hasPrint = Array.isArray(o?.productSnapshot?.processes) &&
                         o.productSnapshot.processes.some(x => /인쇄|print/i.test(String(x)));
        if (!hasPrint) return; // 인쇄 없는 주문은 스킵

        const exists = [
          ...state.pool,
          ...Object.values(state.lanes).flat(),
          ...state.completed
        ].some(c => c.orderId === o.id);
        if (!exists) {
          const qty = Number(o.sheetsQty || o.qty || 0) + Number(o.extraSheets || o.extraQty || 0);
          state.pool.push({
            id: `card_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`,
            orderId: o.id,
            productName: o.productName || '미상',
            vendor: o.vendor || '',
            quantity: qty,
            dueDate: o.dueDate || '',
            status: 'wait',
            createdAt: o.createdAt ? new Date(o.createdAt).toISOString() : new Date().toISOString()
          });
        }
      });

      saveState();
    }

    function renderPool() {
      const container = document.getElementById('assignPool');
      if (!container) return;
      if (state.pool.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#999;padding:40px">미배정 작업이 없습니다</div>';
        return;
      }
      container.innerHTML = '';
      state.pool.forEach(card => {
        const div = document.createElement('div');
        div.className = 'pool-card';
        div.innerHTML = `
          <div class="card-title">${esc(card.productName)}</div>
          <div class="card-meta">
            <div>거래처: ${esc(card.vendor)}</div>
            <div>수량: ${NF.format(card.quantity)}개</div>
            ${card.dueDate ? `<div>납기: ${card.dueDate}</div>` : ''}
          </div>
        `;
        div.addEventListener('click', () => showAssignModal(card));
        container.appendChild(div);
      });
      document.getElementById('poolCount').textContent = state.pool.length;
    }

    function renderLanes() {
      const grid = document.getElementById('lanesGrid');
      if (!grid) return;
      grid.innerHTML = '';
      PRESSES.forEach(p => {
        const lane = document.createElement('div');
        lane.className = 'lane';
        lane.innerHTML = `<h4>${p} (${(state.lanes[p] || []).length})</h4><div class="lane-cards" data-press="${p}"></div>`;
        const cards = lane.querySelector('.lane-cards');
        (state.lanes[p] || []).forEach(card => {
          const div = document.createElement('div');
          div.className = `lane-card ${card.status || 'assigned'}`;
          div.innerHTML = `
            <div class="card-title">${esc(card.productName)}</div>
            <div class="card-meta">
              <div>${esc(card.vendor)} / ${NF.format(card.quantity)}개</div>
              ${card.dueDate ? `<div>납기: ${card.dueDate}</div>` : ''}
            </div>
          `;
          cards.appendChild(div);
        });
        grid.appendChild(lane);
      });
    }

    function showAssignModal(card) {
      selectedCard = card;
      const form = document.getElementById('assignForm');
      if (!form) return;
      form.innerHTML = `
        <div class="row">
          <div class="label">제품</div>
          <div>${esc(card.productName)}</div>
        </div>
        <div class="row">
          <div class="label">수량</div>
          <div>${NF.format(card.quantity)}개</div>
        </div>
        <div class="row">
          <div class="label">배정 기기</div>
          <select id="selectPress">
            ${PRESSES.map(p => `<option value="${p}">${p}</option>`).join('')}
          </select>
        </div>
      `;
      document.getElementById('assignModal').classList.add('show');
    }

    function closeAssignModal() {
      document.getElementById('assignModal').classList.remove('show');
      selectedCard = null;
    }

    function confirmAssign() {
      if (!selectedCard) return;
      const press = document.getElementById('selectPress').value;
      const idx = state.pool.findIndex(c => c.id === selectedCard.id);
      if (idx > -1) {
        const [card] = state.pool.splice(idx, 1);
        card.status = 'assigned';
        card.assignedPress = press;
        card.assignedAt = new Date().toISOString();
        if (!Array.isArray(state.lanes[press])) state.lanes[press] = [];
        state.lanes[press].push(card);
        state.history.push({
          action: 'assign',
          cardId: card.id,
          press: press,
          timestamp: new Date().toISOString()
        });
        saveState();
        renderPool();
        renderLanes();
        closeAssignModal();
      }
    }

    loadState();
    renderPool();
    renderLanes();
  </script>
</body>
</html>