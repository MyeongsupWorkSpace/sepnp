<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì¸ì‡„ë°°ì • - ì„±ì€ì§€ê¸°ì¸ì‡„</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="assets/nav.css">
</head>
<body>
  <!-- ê³ ì • í—¤ë” -->
  <header class="fixed-header"></header>

  <main class="container">
    <section class="card catalog-wrap">
      <div class="catalog">
        <h3>ì¸ì‡„ ë°°ì • ë“±ë¡</h3>
        <form id="assignForm">
          <label>ì œí’ˆ
            <select id="assignProd" required></select>
          </label>

          <!-- ì œí’ˆ ìƒì„¸ ë¯¸ë¦¬ë³´ê¸° -->
          <div id="assignProdPreview" class="mini" style="margin-top:6px;color:var(--muted)"></div>

          <label>ìˆ˜ëŸ‰ <input id="assignQty" type="number" min="1" required></label>
          <label>ë‚©ê¸°ì¼ <input id="assignDue" type="date" required></label>

          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button class="btn primary" type="submit">ë“±ë¡</button>
            <button class="btn" type="button" id="clearAssigns">ì „ì²´ì‚­ì œ</button>
          </div>
        </form>

        <h4 style="margin-top:12px">ë°°ì • í’€ (ë“œë˜ê·¸í•˜ì—¬ ê¸°ê³„ì— ë°°ì¹˜)</h4>
        <input id="searchAssign" class="search" placeholder="ì œí’ˆëª…/ê±°ë˜ì²˜ ê²€ìƒ‰">
        <div class="catalog-list" id="assignPool"></div>
      </div>

      <div class="board">
        <div class="machine-board">
          <h3>1í˜¸ê¸°</h3>
          <div class="machine-droppable" id="m1"></div>
        </div>
        <div class="machine-board">
          <h3>2í˜¸ê¸°</h3>
          <div class="machine-droppable" id="m2"></div>
        </div>
        <div class="machine-board">
          <h3>3í˜¸ê¸°</h3>
          <div class="machine-droppable" id="m3"></div>
        </div>
      </div>
    </section>
  </main>

  <script src="assets/nav.js"></script>
  <script>
    // ë¡œê·¸ì¸ í™•ì¸
    const empNo = sessionStorage.getItem('sepnp_emp_no');
    const empName = sessionStorage.getItem('sepnp_emp_name') || empNo || 'ë¯¸ìƒ';
    if(!empNo) location.href = 'index.html';

    // ========== ê³µí†µ ìœ í‹¸ ==========
    const NF = new Intl.NumberFormat('ko-KR');
    const esc = (s) => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const now = () => new Date().toISOString();
    const today = () => new Date().toISOString().slice(0,10);

    // ========== ì„¤ë¹„ ì •ì˜ ==========
    const MACHINES = [
      { id:'print1', name:'ì¸ì‡„ 1í˜¸ê¸°' },
      { id:'print2', name:'ì¸ì‡„ 2í˜¸ê¸°' },
      { id:'print3', name:'ì¸ì‡„ 3í˜¸ê¸°' }
    ];

    // ========== ìƒíƒœ ê´€ë¦¬ ==========
    let state = {
      pool: [],      // ë¯¸ë°°ì • ì‘ì—…
      lanes: {},     // ê° í˜¸ê¸°ë³„ ì‘ì—…
      completed: []  // ì™„ë£Œëœ ì‘ì—…
    };

    MACHINES.forEach(m => state.lanes[m.id] = []);

    // ========== ì €ì¥/ë¡œë“œ ==========
    function saveState() {
      localStorage.setItem('sepnp_assign_v2', JSON.stringify(state));
    }

    function loadState() {
      const saved = localStorage.getItem('sepnp_assign_v2');
      if(saved) {
        try {
          const parsed = JSON.parse(saved);
          state.pool = Array.isArray(parsed.pool) ? parsed.pool : [];
          state.lanes = parsed.lanes || {};
          state.completed = Array.isArray(parsed.completed) ? parsed.completed : [];
          MACHINES.forEach(m => {
            if(!Array.isArray(state.lanes[m.id])) state.lanes[m.id] = [];
          });
        } catch(e) {
          console.error('loadState error:', e);
        }
      }

      // ========== ìˆ˜ì£¼ ì˜¤ë” â†’ ì¹´ë“œ ë™ê¸°í™” ==========
      const orders = JSON.parse(localStorage.getItem('sepnp_orders_v1') || '[]');
      orders.forEach(o => {
        if(!o.id) return;
        
        // ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ (pool, lanes, completed ëª¨ë‘ ì²´í¬)
        const exists = [
          ...state.pool,
          ...Object.values(state.lanes).flat(),
          ...state.completed
        ].some(c => c.orderId === o.id);
        
        if(!exists) {
          // ìƒˆ ì¹´ë“œ ìƒì„±í•˜ì—¬ ë¯¸ë°°ì • í’€ì— ì¶”ê°€
          state.pool.push({
            id: `card_${Date.now()}_${Math.random().toString(36).slice(2,9)}`,
            orderId: o.id,
            productName: o.productName || 'ë¯¸ìƒ',
            vendor: o.vendor || '',
            quantity: o.quantity || 0,
            dueDate: o.dueDate || '',
            status: 'wait',
            createdAt: o.createdAt || now()
          });
        }
      });

      saveState();
    }

    // ========== ë Œë”ë§ ==========
    function render() {
      renderPool();
      renderLanes();
      renderStats();
    }

    function renderPool() {
      const container = document.getElementById('poolCards');
      if(state.pool.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#999;padding:40px">ë¯¸ë°°ì • ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      container.innerHTML = '';
      state.pool.forEach(card => {
        const div = document.createElement('div');
        div.className = 'pool-card';
        div.innerHTML = `
          <div class="card-title">${esc(card.productName)}</div>
          <div class="card-meta">
            <div>ê±°ë˜ì²˜: ${esc(card.vendor)}</div>
            <div>ìˆ˜ëŸ‰: ${NF.format(card.quantity)}ê°œ</div>
            ${card.dueDate ? `<div>ë‚©ê¸°: ${card.dueDate}</div>` : ''}
          </div>
        `;
        div.addEventListener('click', () => showAssignModal(card));
        container.appendChild(div);
      });
    }

    function renderLanes() {
      const container = document.getElementById('lanesArea');
      container.innerHTML = '';

      MACHINES.forEach(m => {
        const lane = document.createElement('div');
        lane.className = 'lane';

        const cards = state.lanes[m.id] || [];
        const cardsHTML = cards.map(c => {
          const statusClass = c.status === 'prog' ? 'progress' : c.status === 'error' ? 'error' : 'wait';
          const statusText = c.status === 'prog' ? 'ğŸ”µ ì§„í–‰ì¤‘' : c.status === 'error' ? 'ğŸ”´ ê³ ì¥' : 'âšª ëŒ€ê¸°';
          
          return `<div class="work-card ${statusClass}" data-card-id="${c.id}">
            <div class="card-title">${esc(c.productName)}</div>
            <div class="card-meta">
              <div>${statusText}</div>
              <div>ê±°ë˜ì²˜: ${esc(c.vendor)}</div>
              <div>ìˆ˜ëŸ‰: ${NF.format(c.quantity)}ê°œ</div>
            </div>
          </div>`;
        }).join('');

        lane.innerHTML = `
          <div class="lane-header">
            <div class="lane-title">${m.name}</div>
            <div class="lane-count">${cards.length}ê±´</div>
          </div>
          <div class="lane-cards">
            ${cardsHTML || '<div style="text-align:center;color:#999;padding:30px;font-size:13px">ë¹„ì–´ìˆìŒ</div>'}
          </div>
        `;

        lane.querySelectorAll('.work-card').forEach(el => {
          el.addEventListener('click', () => {
            const cardId = el.dataset.cardId;
            const card = cards.find(c => c.id === cardId);
            if(card) showCardModal(card, m.id);
          });
        });

        container.appendChild(lane);
      });
    }

    function renderStats() {
      const totalWait = Object.values(state.lanes).flat().filter(c => c.status === 'wait').length;
      const totalProg = Object.values(state.lanes).flat().filter(c => c.status === 'prog').length;
      const totalError = Object.values(state.lanes).flat().filter(c => c.status === 'error').length;
      const todayCompleted = state.completed.filter(c => c.completedAt && c.completedAt.startsWith(today())).length;

      document.getElementById('statPool').textContent = state.pool.length;
      document.getElementById('statWait').textContent = totalWait;
      document.getElementById('statProg').textContent = totalProg;
      document.getElementById('statError').textContent = totalError;
      document.getElementById('statCompleted').textContent = todayCompleted;
    }

    // ========== ëª¨ë‹¬: ë°°ì • ==========
    function showAssignModal(card) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      const modal = document.createElement('div');
      modal.className = 'modal';

      const machineOpts = MACHINES.map(m => `<option value="${m.id}">${m.name}</option>`).join('');

      modal.innerHTML = `
        <div class="modal-header">
          <h3>ì‘ì—… ë°°ì •</h3>
          <button class="modal-close">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="info-grid">
            <div class="info-row"><span class="label">ì œí’ˆëª…</span><span>${esc(card.productName)}</span></div>
            <div class="info-row"><span class="label">ê±°ë˜ì²˜</span><span>${esc(card.vendor)}</span></div>
            <div class="info-row"><span class="label">ìˆ˜ëŸ‰</span><span>${NF.format(card.quantity)}ê°œ</span></div>
            ${card.dueDate ? `<div class="info-row"><span class="label">ë‚©ê¸°</span><span>${card.dueDate}</span></div>` : ''}
          </div>
          <div class="form-group">
            <label>ë°°ì • í˜¸ê¸°</label>
            <select id="machineSelect" class="form-control">${machineOpts}</select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="this.closest('.modal-overlay').remove()">ì·¨ì†Œ</button>
          <button class="btn btn-primary" id="btnConfirmAssign">ë°°ì •</button>
        </div>
      `;

      overlay.appendChild(modal);
      document.body.appendChild(overlay);

      modal.querySelector('.modal-close').onclick = () => overlay.remove();
      overlay.onclick = (e) => { if(e.target === overlay) overlay.remove(); };

      modal.querySelector('#btnConfirmAssign').onclick = () => {
        const machineId = modal.querySelector('#machineSelect').value;
        const idx = state.pool.findIndex(c => c.id === card.id);
        if(idx >= 0) {
          state.pool.splice(idx, 1);
          card.status = 'wait';
          state.lanes[machineId].push(card);
          saveState();
          render();
          overlay.remove();
        }
      };
    }

    // ========== ëª¨ë‹¬: ì¹´ë“œ ìƒì„¸ ==========
    function showCardModal(card, machineId) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      const modal = document.createElement('div');
      modal.className = 'modal';

      const statusOpts = ['wait','prog','error'].map(s => {
        const label = s === 'wait' ? 'ëŒ€ê¸°' : s === 'prog' ? 'ì§„í–‰ì¤‘' : 'ê³ ì¥';
        const sel = card.status === s ? 'selected' : '';
        return `<option value="${s}" ${sel}>${label}</option>`;
      }).join('');

      modal.innerHTML = `
        <div class="modal-header">
          <h3>ì‘ì—… ê´€ë¦¬</h3>
          <button class="modal-close">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="info-grid">
            <div class="info-row"><span class="label">ì œí’ˆëª…</span><span>${esc(card.productName)}</span></div>
            <div class="info-row"><span class="label">ê±°ë˜ì²˜</span><span>${esc(card.vendor)}</span></div>
            <div class="info-row"><span class="label">ìˆ˜ëŸ‰</span><span>${NF.format(card.quantity)}ê°œ</span></div>
          </div>
          <div class="form-group">
            <label>ìƒíƒœ</label>
            <select id="statusSelect" class="form-control">${statusOpts}</select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger" id="btnUnassign">ë°°ì • í•´ì œ</button>
          <button class="btn" onclick="this.closest('.modal-overlay').remove()">ì·¨ì†Œ</button>
          <button class="btn btn-success" id="btnComplete">ì™„ë£Œ</button>
        </div>
      `;

      overlay.appendChild(modal);
      document.body.appendChild(overlay);

      modal.querySelector('.modal-close').onclick = () => overlay.remove();
      overlay.onclick = (e) => { if(e.target === overlay) overlay.remove(); };

      // ìƒíƒœ ë³€ê²½ ì¦‰ì‹œ ë°˜ì˜
      modal.querySelector('#statusSelect').onchange = (e) => {
        card.status = e.target.value;
        if(card.status === 'prog' && !card.startedAt) {
          card.startedAt = now();
        }
        saveState();
        render();
      };

      // ë°°ì • í•´ì œ
      modal.querySelector('#btnUnassign').onclick = () => {
        if(confirm('ë°°ì •ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          const idx = state.lanes[machineId].findIndex(c => c.id === card.id);
          if(idx >= 0) {
            state.lanes[machineId].splice(idx, 1);
            card.status = 'wait';
            delete card.startedAt;
            state.pool.push(card);
            saveState();
            render();
            overlay.remove();
          }
        }
      };

      // ì™„ë£Œ ì²˜ë¦¬
      modal.querySelector('#btnComplete').onclick = () => {
        if(confirm('ì‘ì—…ì„ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          const idx = state.lanes[machineId].findIndex(c => c.id === card.id);
          if(idx >= 0) {
            state.lanes[machineId].splice(idx, 1);
            card.status = 'done';
            card.completedAt = now();
            card.completedBy = empName;
            state.completed.push(card);
            saveState();
            render();
            overlay.remove();
          }
        }
      };
    }

    // ========== ì´ˆê¸°í™” ==========
    loadState();
    render();
  </script>
</body>
</html>