<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>제품등록 / 배치 - 성은지기인쇄</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="site-header">
    <h1 class="brand">성은지기인쇄</h1>
    <nav class="main-nav">
      <a href="print-plan.html">인쇄계획표</a>
      <a href="jobs.html">작업현황</a>
      <a href="inventory.html">재고현황</a>
      <a href="product.html">제품등록</a>
    </nav>
    <div class="hdr-actions"><a href="employee.html" class="btn">홈</a></div>
  </header>

  <main class="container">
    <section class="card catalog-wrap">
      <div class="catalog">
        <h3>제품 등록</h3>
        <form id="prodForm">
          <label>제품명 <input id="prodName" required></label>
          <label>설명 <input id="prodDesc"></label>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button class="btn primary" type="submit">등록</button>
            <button class="btn" type="button" id="clearProducts">전체삭제</button>
          </div>
        </form>

        <h4 style="margin-top:12px">제품 검색</h4>
        <input id="search" class="search" placeholder="제품명으로 검색">

        <div class="catalog-list" id="catalogList" aria-live="polite"></div>
      </div>

      <div class="board">
        <div class="machine-board" data-machine="1">
          <h3>1호기</h3>
          <div class="machine-droppable" id="machine1"></div>
        </div>
        <div class="machine-board" data-machine="2">
          <h3>2호기</h3>
          <div class="machine-droppable" id="machine2"></div>
        </div>
        <div class="machine-board" data-machine="3">
          <h3>3호기</h3>
          <div class="machine-droppable" id="machine3"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const PROD_KEY = 'sepnp_products_v1';
    const ASSIGN_KEY = 'sepnp_assign_v1';

    // sample initial products (will persist after first save)
    const SAMPLE = [
      { id: 'P001', name: 'ABC초코쿠키(50g)', desc:'케이스 포함' },
      { id: 'P002', name: 'ABC초코쿠키(152g)', desc:'대량' },
      { id: 'P003', name: '카프리샌' , desc:'샘플' }
    ];

    function loadProducts(){ const raw = localStorage.getItem(PROD_KEY); return raw? JSON.parse(raw): SAMPLE.slice(); }
    function saveProducts(list){ localStorage.setItem(PROD_KEY, JSON.stringify(list)); }

    function loadAssign(){ const raw = localStorage.getItem(ASSIGN_KEY); return raw? JSON.parse(raw): {1:[],2:[],3:[]}; }
    function saveAssign(a){ localStorage.setItem(ASSIGN_KEY, JSON.stringify(a)); }

    const catalogList = document.getElementById('catalogList');
    const search = document.getElementById('search');
    const form = document.getElementById('prodForm');
    const prodName = document.getElementById('prodName');
    const prodDesc = document.getElementById('prodDesc');
    const clearProducts = document.getElementById('clearProducts');

    // render products in catalog (filter via search)
    function renderCatalog(){
      const q = search.value.trim().toLowerCase();
      const products = loadProducts();
      catalogList.innerHTML = '';
      products.filter(p => p.name.toLowerCase().includes(q) || (p.desc||'').toLowerCase().includes(q))
        .forEach(p => {
          const div = document.createElement('div');
          div.className = 'prod-item';
          div.draggable = true;
          div.dataset.id = p.id;
          div.innerHTML = `<strong>${p.name}</strong><div class="mini">${p.desc||''} <span style="color:#888">[${p.id}]</span></div>`;
          div.addEventListener('dragstart', (ev) => {
            ev.dataTransfer.setData('text/plain', JSON.stringify({ type:'product', id:p.id, name:p.name }));
          });
          catalogList.appendChild(div);
        });
      if(catalogList.childElementCount === 0){
        catalogList.innerHTML = '<div class="mini">검색 결과가 없습니다.</div>';
      }
    }

    // register product
    form.addEventListener('submit', e=>{
      e.preventDefault();
      const name = prodName.value.trim();
      if(!name) return;
      const products = loadProducts();
      // create id simple
      const id = 'P' + String(Math.floor(Math.random()*9000)+1000);
      products.push({ id, name, desc: prodDesc.value.trim() });
      saveProducts(products);
      form.reset();
      renderCatalog();
    });

    clearProducts.addEventListener('click', ()=>{
      if(!confirm('모든 제품을 삭제하시겠습니까?')) return;
      localStorage.removeItem(PROD_KEY);
      renderCatalog();
    });

    search.addEventListener('input', renderCatalog);

    // machines droppable
    const machines = [1,2,3];
    machines.forEach(n => {
      const el = document.getElementById('machine'+n);
      el.addEventListener('dragover', ev => ev.preventDefault());
      el.addEventListener('drop', ev => {
        ev.preventDefault();
        const data = ev.dataTransfer.getData('text/plain');
        if(!data) return;
        try{
          const parsed = JSON.parse(data);
          if(parsed.type === 'product'){
            const assign = loadAssign();
            assign[n] = assign[n] || [];
            // avoid duplicate same id in same machine
            if(!assign[n].some(x=>x.id === parsed.id)){
              assign[n].push({ id: parsed.id, name: parsed.name });
              saveAssign(assign);
              renderBoards();
            }else{
              alert('이미 해당 기계에 등록된 제품입니다.');
            }
          }else if(parsed.fromMachine){
            // move between machines handled in dragend logic
          }
        }catch(e){}
      });
    });

    // render machine boards and enable reordering / removal via drag
    function renderBoards(){
      const assign = loadAssign();
      machines.forEach(n=>{
        const el = document.getElementById('machine'+n);
        el.innerHTML = '';
        (assign[n]||[]).forEach((p, idx)=>{
          const div = document.createElement('div');
          div.className = 'slot';
          div.draggable = true;
          div.textContent = `${p.name} [${p.id}]`;
          div.dataset.machine = n;
          div.dataset.index = idx;
          // dragstart: include fromMachine,index and payload as string
          div.addEventListener('dragstart', ev=>{
            ev.dataTransfer.setData('text/plain', JSON.stringify({ fromMachine: Number(ev.target.dataset.machine), index: Number(ev.target.dataset.index) }));
            setTimeout(()=> ev.target.classList.add('dragging'),0);
          });
          div.addEventListener('dragend', ev=>{
            document.querySelectorAll('.slot').forEach(s=>s.classList.remove('dragging'));
          });
          // right-click to remove
          div.addEventListener('contextmenu', ev=>{
            ev.preventDefault();
            if(!confirm('이 제품을 이 기계에서 제거하시겠습니까?')) return;
            const a = loadAssign();
            a[n].splice(idx,1);
            saveAssign(a); renderBoards();
          });
          el.appendChild(div);
        });
      });
    }

    // allow dropping a moving slot into a machine at a particular position (append for simplicity)
    machines.forEach(n=>{
      const el = document.getElementById('machine'+n);
      el.addEventListener('dragover', ev => ev.preventDefault());
      el.addEventListener('drop', ev=>{
        ev.preventDefault();
        const data = ev.dataTransfer.getData('text/plain');
        if(!data) return;
        try{
          const parsed = JSON.parse(data);
          if(parsed.fromMachine !== undefined){
            const from = parsed.fromMachine;
            const idx = parsed.index;
            const a = loadAssign();
            const moving = a[from].splice(idx,1)[0];
            if(moving){
              a[n] = a[n] || [];
              a[n].push(moving);
              saveAssign(a);
              renderBoards();
            }
          }
        }catch(e){}
      });
    });

    // initial setup
    if(!localStorage.getItem(PROD_KEY)) saveProducts(SAMPLE);
    if(!localStorage.getItem(ASSIGN_KEY)) saveAssign({1:[],2:[],3:[]});
    renderCatalog();
    renderBoards();

    // Export/import helper (옵션)
    // 예: 로컬 스토리지 초기화 외에 데이터 내보내기/복원 필요하면 추가 가능
  </script>
</body>
</html>