<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>매출현황</title>
  <link rel="stylesheet" href="assets/nav.css">
  <style>
    :root{ --bd:#e5e7eb; --fg:#111; --mut:#6b7280; --bg:#f5f6f8; --card:#fff; --primary:#2563eb; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;padding-top:60px}
    .container{max-width:1400px;margin:16px auto;padding:0 12px}
    h2{margin:0 0 12px;font-size:20px;font-weight:800}
    h3{margin:0 0 12px;font-size:16px;font-weight:700}

    .card{background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:20px;margin-bottom:16px}

    /* 통계 카드 */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
    .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .stat-card.blue{background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%)}
    .stat-card.green{background:linear-gradient(135deg,#10b981 0%,#059669 100%)}
    .stat-card.orange{background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%)}
    .stat-card.purple{background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%)}
    .stat-card .label{font-size:13px;opacity:.9;margin-bottom:8px;font-weight:500}
    .stat-card .value{font-size:32px;font-weight:800;margin-bottom:4px}
    .stat-card .sub{font-size:12px;opacity:.8}

    /* 필터 */
    .filter-bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:16px;padding:16px;background:#f9fafb;border-radius:8px}
    .filter-bar select,.filter-bar input{height:36px;padding:0 12px;border:1px solid var(--bd);border-radius:6px;font-size:13px;background:#fff}
    .filter-bar .btn{height:36px;padding:0 16px;border:1px solid var(--bd);border-radius:6px;font-size:13px;background:#fff;cursor:pointer;font-weight:600}
    .filter-bar .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}

    /* 차트 */
    .chart-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px;margin-bottom:24px}
    @media(max-width:900px){.chart-container{grid-template-columns:1fr}}
    .chart-box{background:#fff;border:1px solid var(--bd);border-radius:10px;padding:20px}
    .chart-canvas{width:100%;height:300px;border:1px solid #f1f3f5;border-radius:8px;background:#fafbfc}

    /* 테이블 */
    .table-wrap{border:1px solid var(--bd);border-radius:8px;overflow:auto}
    table{width:100%;border-collapse:collapse;background:#fff;font-size:13px}
    thead{background:#f8f9fa;position:sticky;top:0}
    th,td{padding:12px;border-bottom:1px solid #f1f3f5;text-align:center}
    th{font-weight:600;white-space:nowrap}
    tbody tr:hover{background:#fbfcfd}
    .align-right{text-align:right}
    .align-left{text-align:left}

    /* 뱃지 */
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:11px;font-weight:700}
    .badge.done{background:#d1fae5;color:#065f46}
    .badge.progress{background:#dbeafe;color:#1e40af}
    .badge.cancel{background:#fee2e2;color:#991b1b}

    /* 탭 */
    .tabs{display:flex;gap:4px;margin-bottom:16px;border-bottom:2px solid #e5e7eb}
    .tab{padding:10px 20px;border:none;background:none;cursor:pointer;font-size:14px;font-weight:600;color:#6b7280;border-bottom:2px solid transparent;margin-bottom:-2px}
    .tab.active{color:var(--primary);border-bottom-color:var(--primary)}

    /* 로딩 */
    .loading{text-align:center;padding:40px;color:var(--mut)}
  </style>
</head>
<body>
  <header class="fixed-header"></header>

  <main class="container" data-perm="sales.view" data-perm-mode="hide">
    <h2>매출 현황</h2>

    <!-- 필터 -->
    <div class="filter-bar">
      <span style="font-size:13px;font-weight:600;color:#374151">기간:</span>
      <input id="dateFrom" type="date" style="width:140px">
      <span style="color:#6b7280">~</span>
      <input id="dateTo" type="date" style="width:140px">
      <select id="filterStatus" style="width:120px">
        <option value="">전체 상태</option>
        <option value="done">완료만</option>
        <option value="progress">진행중</option>
        <option value="cancel">취소</option>
      </select>
      <select id="filterProduct" style="flex:1;min-width:200px">
        <option value="">전체 제품</option>
      </select>
      <button class="btn primary" onclick="applyFilter()">조회</button>
      <button class="btn" onclick="resetFilter()">초기화</button>
    </div>

    <!-- 통계 카드 -->
    <div class="stats-grid">
      <div class="stat-card blue">
        <div class="label">총 출고 건수</div>
        <div class="value" id="statTotalCount">0</div>
        <div class="sub" id="statTotalSub">완료: 0 | 진행: 0</div>
      </div>
      <div class="stat-card green">
        <div class="label">총 출고 수량</div>
        <div class="value" id="statTotalQty">0</div>
        <div class="sub">모든 제품 합계</div>
      </div>
      <div class="stat-card orange">
        <div class="label">월평균 출고</div>
        <div class="value" id="statMonthlyAvg">0</div>
        <div class="sub" id="statMonthlySub">최근 3개월 기준</div>
      </div>
      <div class="stat-card purple">
        <div class="label">주요 거래처</div>
        <div class="value" id="statTopCustomer">-</div>
        <div class="sub" id="statTopCustomerSub">출고 건수 기준</div>
      </div>
    </div>

    <!-- 탭 -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('chart')">차트 분석</button>
      <button class="tab" onclick="switchTab('table')">상세 내역</button>
      <button class="tab" onclick="switchTab('product')">제품별 현황</button>
      <button class="tab" onclick="switchTab('customer')">거래처별 현황</button>
    </div>

    <!-- 차트 탭 -->
    <div id="chartTab" class="tab-content">
      <div class="chart-container">
        <div class="chart-box">
          <h3>일별 출고 추이</h3>
          <canvas id="dailyChart" class="chart-canvas"></canvas>
        </div>
        <div class="chart-box">
          <h3>제품별 출고 비율</h3>
          <canvas id="productChart" class="chart-canvas"></canvas>
        </div>
        <div class="chart-box">
          <h3>상태별 분포</h3>
          <canvas id="statusChart" class="chart-canvas"></canvas>
        </div>
        <div class="chart-box">
          <h3>거래처별 출고 현황</h3>
          <canvas id="customerChart" class="chart-canvas"></canvas>
        </div>
      </div>
    </div>

    <!-- 상세 내역 탭 -->
    <div id="tableTab" class="tab-content" style="display:none">
      <div class="card">
        <h3>출고 상세 내역</h3>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>배차일</th>
                <th class="align-left">제품명</th>
                <th>규격</th>
                <th class="align-left">거래처</th>
                <th class="align-left">배송지</th>
                <th class="align-right">수량</th>
                <th>차량</th>
                <th>기사</th>
                <th>상태</th>
              </tr>
            </thead>
            <tbody id="detailTableBody">
              <tr><td colspan="9" class="loading">데이터를 불러오는 중...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 제품별 현황 탭 -->
    <div id="productTab" class="tab-content" style="display:none">
      <div class="card">
        <h3>제품별 출고 현황</h3>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th class="align-left">제품명</th>
                <th>규격</th>
                <th class="align-right">총 출고량</th>
                <th class="align-right">완료</th>
                <th class="align-right">진행중</th>
                <th class="align-right">취소</th>
                <th class="align-right">평균 출고량</th>
              </tr>
            </thead>
            <tbody id="productTableBody">
              <tr><td colspan="7" class="loading">데이터를 불러오는 중...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 거래처별 현황 탭 -->
    <div id="customerTab" class="tab-content" style="display:none">
      <div class="card">
        <h3>거래처별 출고 현황</h3>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th class="align-left">거래처</th>
                <th class="align-right">총 출고 건수</th>
                <th class="align-right">총 수량</th>
                <th class="align-left">주요 제품</th>
                <th>최근 출고일</th>
              </tr>
            </thead>
            <tbody id="customerTableBody">
              <tr><td colspan="5" class="loading">데이터를 불러오는 중...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </main>

  <script src="assets/perm.js"></script>
  <script src="assets/nav.js"></script>
  <script>
    const KEY_DISPATCH = 'sepnp_dispatches';
    const $ = s => document.querySelector(s);
    const fmtNum = v => Number(v||0).toLocaleString();
    const today = () => new Date().toISOString().slice(0,10);

    let allData = [];
    let filteredData = [];
    let currentTab = 'chart';

    function loadData(){
      allData = JSON.parse(localStorage.getItem(KEY_DISPATCH)||'[]');
      
      // 제품 필터 옵션 생성
      const products = [...new Set(allData.map(d => d.productName))];
      $('#filterProduct').innerHTML = '<option value="">전체 제품</option>' + 
        products.map(p => `<option value="${p}">${p}</option>`).join('');
      
      // 기본 기간: 최근 30일
      const to = new Date();
      const from = new Date(to);
      from.setDate(from.getDate() - 30);
      
      $('#dateTo').value = to.toISOString().slice(0,10);
      $('#dateFrom').value = from.toISOString().slice(0,10);
      
      applyFilter();
    }

    function applyFilter(){
      const from = $('#dateFrom').value;
      const to = $('#dateTo').value;
      const status = $('#filterStatus').value;
      const product = $('#filterProduct').value;

      filteredData = allData.filter(d => {
        const matchDate = (!from || d.date >= from) && (!to || d.date <= to);
        const matchStatus = !status || d.status === status;
        const matchProduct = !product || d.productName === product;
        return matchDate && matchStatus && matchProduct;
      });

      updateStats();
      updateCharts();
      updateTables();
    }

    function resetFilter(){
      $('#filterStatus').value = '';
      $('#filterProduct').value = '';
      const to = new Date();
      const from = new Date(to);
      from.setDate(from.getDate() - 30);
      $('#dateTo').value = to.toISOString().slice(0,10);
      $('#dateFrom').value = from.toISOString().slice(0,10);
      applyFilter();
    }

    function updateStats(){
      const total = filteredData.length;
      const done = filteredData.filter(d => d.status === 'done').length;
      const progress = filteredData.filter(d => d.status === 'progress').length;
      const totalQty = filteredData.reduce((sum, d) => sum + (d.qty||0), 0);

      $('#statTotalCount').textContent = fmtNum(total);
      $('#statTotalSub').textContent = `완료: ${fmtNum(done)} | 진행: ${fmtNum(progress)}`;
      $('#statTotalQty').textContent = fmtNum(totalQty);

      // 월평균 계산
      const months = new Set(filteredData.map(d => d.date.slice(0,7))).size || 1;
      const monthlyAvg = Math.round(total / months);
      $('#statMonthlyAvg').textContent = fmtNum(monthlyAvg);
      $('#statMonthlySub').textContent = `${months}개월 기준`;

      // 주요 거래처
      const customerCounts = {};
      filteredData.forEach(d => {
        if(d.customer) customerCounts[d.customer] = (customerCounts[d.customer]||0) + 1;
      });
      const topCustomer = Object.entries(customerCounts).sort((a,b) => b[1]-a[1])[0];
      if(topCustomer){
        $('#statTopCustomer').textContent = topCustomer[0];
        $('#statTopCustomerSub').textContent = `${fmtNum(topCustomer[1])}건`;
      } else {
        $('#statTopCustomer').textContent = '-';
        $('#statTopCustomerSub').textContent = '데이터 없음';
      }
    }

    function updateCharts(){
      drawDailyChart();
      drawProductChart();
      drawStatusChart();
      drawCustomerChart();
    }

    function updateTables(){
      updateDetailTable();
      updateProductTable();
      updateCustomerTable();
    }

    function drawDailyChart(){
      const canvas = $('#dailyChart');
      const ctx = canvas.getContext('2d');
      const w = canvas.width = canvas.offsetWidth;
      const h = canvas.height = canvas.offsetHeight;

      ctx.clearRect(0,0,w,h);

      // 일별 집계
      const dailyData = {};
      filteredData.forEach(d => {
        dailyData[d.date] = (dailyData[d.date]||0) + 1;
      });

      const dates = Object.keys(dailyData).sort();
      if(dates.length === 0){
        ctx.fillStyle = '#6b7280';
        ctx.font = '13px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('데이터가 없습니다', w/2, h/2);
        return;
      }

      const values = dates.map(d => dailyData[d]);
      const max = Math.max(...values);
      const padding = 40;
      const barWidth = (w - padding * 2) / dates.length;

      // 배경 그리드
      ctx.strokeStyle = '#e5e7eb';
      ctx.lineWidth = 1;
      for(let i=0; i<=5; i++){
        const y = padding + (h - padding * 2) * i / 5;
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(w - padding, y);
        ctx.stroke();
      }

      // 바 그래프
      values.forEach((val, i) => {
        const barHeight = ((h - padding * 2) * val / max);
        const x = padding + i * barWidth;
        const y = h - padding - barHeight;

        ctx.fillStyle = '#3b82f6';
        ctx.fillRect(x + 2, y, barWidth - 4, barHeight);

        // 값 표시
        ctx.fillStyle = '#111';
        ctx.font = '11px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(val, x + barWidth/2, y - 5);

        // 날짜 (간격 조절)
        if(dates.length < 15 || i % Math.ceil(dates.length/10) === 0){
          ctx.fillStyle = '#6b7280';
          ctx.font = '10px sans-serif';
          ctx.save();
          ctx.translate(x + barWidth/2, h - padding + 15);
          ctx.rotate(-Math.PI/4);
          ctx.fillText(dates[i].slice(5), 0, 0);
          ctx.restore();
        }
      });
    }

    function drawProductChart(){
      const canvas = $('#productChart');
      const ctx = canvas.getContext('2d');
      const w = canvas.width = canvas.offsetWidth;
      const h = canvas.height = canvas.offsetHeight;

      ctx.clearRect(0,0,w,h);

      // 제품별 집계
      const productData = {};
      filteredData.forEach(d => {
        productData[d.productName] = (productData[d.productName]||0) + (d.qty||0);
      });

      const products = Object.entries(productData).sort((a,b) => b[1]-a[1]).slice(0,5);
      if(products.length === 0){
        ctx.fillStyle = '#6b7280';
        ctx.font = '13px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('데이터가 없습니다', w/2, h/2);
        return;
      }

      const total = products.reduce((sum, p) => sum + p[1], 0);
      const colors = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6'];

      let startAngle = -Math.PI/2;
      const centerX = w/2;
      const centerY = h/2 - 20;
      const radius = Math.min(w,h) / 3;

      products.forEach(([name, qty], i) => {
        const sliceAngle = (qty / total) * Math.PI * 2;
        
        ctx.fillStyle = colors[i];
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
        ctx.closePath();
        ctx.fill();

        // 레이블
        const midAngle = startAngle + sliceAngle / 2;
        const labelX = centerX + Math.cos(midAngle) * (radius + 30);
        const labelY = centerY + Math.sin(midAngle) * (radius + 30);
        
        ctx.fillStyle = '#111';
        ctx.font = '11px sans-serif';
        ctx.textAlign = labelX > centerX ? 'left' : 'right';
        ctx.fillText(`${name}`, labelX, labelY);
        ctx.fillText={`${((qty/total)*100).toFixed(1)}%`, labelX, labelY + 12);

        startAngle += sliceAngle;
      });
    }

    function drawStatusChart(){
      const canvas = $('#statusChart');
      const ctx = canvas.getContext('2d');
      const w = canvas.width = canvas.offsetWidth;
      const h = canvas.height = canvas.offsetHeight;

      ctx.clearRect(0,0,w,h);

      const done = filteredData.filter(d => d.status === 'done').length;
      const progress = filteredData.filter(d => d.status === 'progress').length;
      const cancel = filteredData.filter(d => d.status === 'cancel').length;
      const wait = filteredData.filter(d => d.status === 'wait').length;

      const data = [
        {label:'완료', value:done, color:'#10b981'},
        {label:'진행중', value:progress, color:'#3b82f6'},
        {label:'대기', value:wait, color:'#f59e0b'},
        {label:'취소', value:cancel, color:'#ef4444'}
      ].filter(d => d.value > 0);

      if(data.length === 0){
        ctx.fillStyle = '#6b7280';
        ctx.font = '13px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('데이터가 없습니다', w/2, h/2);
        return;
      }

      const total = data.reduce((sum, d) => sum + d.value, 0);
      const barHeight = 40;
      const startY = (h - data.length * (barHeight + 10)) / 2;

      data.forEach((item, i) => {
        const barWidth = (w - 160) * (item.value / total);
        const y = startY + i * (barHeight + 10);

        ctx.fillStyle = item.color;
        ctx.fillRect(80, y, barWidth, barHeight);

        ctx.fillStyle = '#111';
        ctx.font = '13px sans-serif';
        ctx.textAlign = 'right';
        ctx.fillText(item.label, 70, y + barHeight/2 + 5);

        ctx.textAlign = 'left';
        ctx.fillText(`${item.value}건 (${((item.value/total)*100).toFixed(1)}%)`, 85 + barWidth, y + barHeight/2 + 5);
      });
    }

    function drawCustomerChart(){
      const canvas = $('#customerChart');
      const ctx = canvas.getContext('2d');
      const w = canvas.width = canvas.offsetWidth;
      const h = canvas.height = canvas.offsetHeight;

      ctx.clearRect(0,0,w,h);

      // 거래처별 집계
      const customerData = {};
      filteredData.forEach(d => {
        if(d.customer) customerData[d.customer] = (customerData[d.customer]||0) + 1;
      });

      const customers = Object.entries(customerData).sort((a,b) => b[1]-a[1]).slice(0,8);
      if(customers.length === 0){
        ctx.fillStyle = '#6b7280';
        ctx.font = '13px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('데이터가 없습니다', w/2, h/2);
        return;
      }

      const max = Math.max(...customers.map(c => c[1]));
      const padding = 40;
      const barHeight = (h - padding * 2) / customers.length;

      customers.forEach(([name, count], i) => {
        const barWidth = (w - padding - 120) * (count / max);
        const y = padding + i * barHeight;

        ctx.fillStyle = '#3b82f6';
        ctx.fillRect(120, y + 5, barWidth, barHeight - 10);

        ctx.fillStyle = '#111';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'right';
        ctx.fillText(name.length > 10 ? name.slice(0,10)+'...' : name, 115, y + barHeight/2 + 4);

        ctx.textAlign = 'left';
        ctx.fillText(`${count}건`, 125 + barWidth, y + barHeight/2 + 4);
      });
    }

    function updateDetailTable(){
      const tbody = $('#detailTableBody');
      if(filteredData.length === 0){
        tbody.innerHTML = '<tr><td colspan="9" style="padding:40px;color:#6b7280">데이터가 없습니다</td></tr>';
        return;
      }

      tbody.innerHTML = filteredData.map(d => `
        <tr>
          <td>${d.date}</td>
          <td class="align-left">${d.productName}</td>
          <td>${d.spec||'-'}</td>
          <td class="align-left">${d.customer||'-'}</td>
          <td class="align-left">${d.dest||'-'}</td>
          <td class="align-right">${fmtNum(d.qty)}${d.unit||''}</td>
          <td>${d.vehicle||'-'}</td>
          <td>${d.driver||'-'}</td>
          <td><span class="badge ${d.status}">${getStatusLabel(d.status)}</span></td>
        </tr>
      `).join('');
    }

    function updateProductTable(){
      const tbody = $('#productTableBody');
      
      // 제품별 집계
      const productStats = {};
      filteredData.forEach(d => {
        if(!productStats[d.productName]){
          productStats[d.productName] = {
            spec: d.spec,
            total: 0,
            done: 0,
            progress: 0,
            cancel: 0,
            count: 0
          };
        }
        const stat = productStats[d.productName];
        stat.total += (d.qty||0);
        stat.count++;
        if(d.status === 'done') stat.done += (d.qty||0);
        else if(d.status === 'progress') stat.progress += (d.qty||0);
        else if(d.status === 'cancel') stat.cancel += (d.qty||0);
      });

      const products = Object.entries(productStats).sort((a,b) => b[1].total - a[1].total);

      if(products.length === 0){
        tbody.innerHTML = '<tr><td colspan="7" style="padding:40px;color:#6b7280">데이터가 없습니다</td></tr>';
        return;
      }

      tbody.innerHTML = products.map(([name, stat]) => `
        <tr>
          <td class="align-left">${name}</td>
          <td>${stat.spec||'-'}</td>
          <td class="align-right"><strong>${fmtNum(stat.total)}</strong></td>
          <td class="align-right">${fmtNum(stat.done)}</td>
          <td class="align-right">${fmtNum(stat.progress)}</td>
          <td class="align-right">${fmtNum(stat.cancel)}</td>
          <td class="align-right">${fmtNum(Math.round(stat.total/stat.count))}</td>
        </tr>
      `).join('');
    }

    function updateCustomerTable(){
      const tbody = $('#customerTableBody');
      
      // 거래처별 집계
      const customerStats = {};
      filteredData.forEach(d => {
        if(!d.customer) return;
        if(!customerStats[d.customer]){
          customerStats[d.customer] = {
            count: 0,
            qty: 0,
            products: {},
            lastDate: d.date
          };
        }
        const stat = customerStats[d.customer];
        stat.count++;
        stat.qty += (d.qty||0);
        stat.products[d.productName] = (stat.products[d.productName]||0) + 1;
        if(d.date > stat.lastDate) stat.lastDate = d.date;
      });

      const customers = Object.entries(customerStats).sort((a,b) => b[1].count - a[1].count);

      if(customers.length === 0){
        tbody.innerHTML = '<tr><td colspan="5" style="padding:40px;color:#6b7280">데이터가 없습니다</td></tr>';
        return;
      }

      tbody.innerHTML = customers.map(([name, stat]) => {
        const topProduct = Object.entries(stat.products).sort((a,b) => b[1]-a[1])[0];
        return `
          <tr>
            <td class="align-left"><strong>${name}</strong></td>
            <td class="align-right">${fmtNum(stat.count)}</td>
            <td class="align-right">${fmtNum(stat.qty)}</td>
            <td class="align-left">${topProduct[0]} (${topProduct[1]}건)</td>
            <td>${stat.lastDate}</td>
          </tr>
        `;
      }).join('');
    }

    function getStatusLabel(status){
      const labels = {
        'wait': '대기',
        'progress': '진행중',
        'done': '완료',
        'cancel': '취소'
      };
      return labels[status] || status;
    }

    function switchTab(tab){
      currentTab = tab;
      
      // 탭 버튼 활성화
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      // 탭 컨텐츠 표시
      document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
      $(`#${tab}Tab`).style.display = 'block';
    }

    // 초기화
    document.addEventListener('DOMContentLoaded', () => {
      if(!Permissions.has('sales.view')){
        alert('매출현황을 볼 권한이 없습니다.');
        // 권한 없으면 홈으로
        try{ window.location.href='employee.html'; }catch(e){}
        return;
      }
      Permissions.applyGates();
      loadData();
      
      // 윈도우 리사이즈 시 차트 다시 그리기
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          if(currentTab === 'chart') updateCharts();
        }, 250);
      });
    });
  </script>
</body>
</html>