<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì‘ì—… í˜„í™©</title>
  <link rel="stylesheet" href="assets/nav.css">
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --bd:#e5e7eb; --mut:#6b7280; --fg:#111;
      --primary:#2563eb; --laneW:280px; --radius:10px;
      --wait:#fef3c7; --progress:#d1fae5; --done:#dbeafe;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;padding-top:60px}
    
    header{position:sticky;top:60px;background:#fff;border-bottom:1px solid var(--bd);padding:10px 16px;z-index:5}
    main{max-width:1600px;margin:14px auto;padding:0 16px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .tab{padding:8px 14px;border:1px solid var(--bd);border-radius:999px;background:#fff;cursor:pointer;font-weight:600}
    .tab.active{background:#e9f0ff;border-color:#9cc0ff;color:#0b58f2}
    .actions{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .btn{height:34px;padding:0 12px;border:1px solid var(--bd);border-radius:8px;background:#fff;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.danger{background:#dc2626;border-color:#dc2626;color:#fff}
    .board{display:none}
    .board.active{display:block}
    
    /* ì˜¤ëŠ˜ ì™„ë£Œ ì„¹ì…˜ */
    .today-completed{background:var(--card);border:1px solid var(--bd);border-radius:var(--radius);margin-bottom:14px;padding:14px}
    .today-completed h3{margin:0 0 10px;font-size:15px;font-weight:700}
    .today-completed .list{display:flex;flex-wrap:wrap;gap:10px}
    .today-completed .mini-card{padding:8px 12px;border:1px solid #d1fae5;border-radius:8px;background:#ecfdf5;cursor:pointer;font-size:13px}
    .today-completed .mini-card:hover{background:#d1fae5}
    
    /* ëŒ€ê¸°í’€ */
    .pool-lane{background:var(--card);border:1px solid var(--bd);border-radius:var(--radius);margin-bottom:14px}
    .pool-lane h3{margin:0;padding:10px 14px;border-bottom:1px solid var(--bd);font-size:15px;font-weight:700}
    .pool-lane .count{color:var(--mut);font-weight:500;margin-left:6px}
    .pool-lane .drop{padding:12px;display:flex;flex-wrap:wrap;gap:12px;min-height:140px}
    .pool-lane .drop.dragover{outline:2px dashed #9bb7ff;outline-offset:-6px}
    
    /* ì„¤ë¹„ ë ˆì¸ */
    .machine-lanes{display:grid;grid-template-columns:repeat(auto-fill, minmax(var(--laneW),1fr));gap:12px}
    .lane{background:var(--card);border:1px solid var(--bd);border-radius:var(--radius);display:flex;flex-direction:column;position:relative}
    .lane.broken{opacity:0.5;pointer-events:none}
    .lane.broken::after{content:'ê³ ì¥';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:48px;font-weight:900;color:#dc2626;opacity:0.3;pointer-events:none}
    .lane h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--bd);font-size:14px;display:flex;align-items:center;justify-content:space-between}
    .lane h3 .title-left{display:flex;align-items:center;gap:6px}
    .lane h3 .broken-check{display:flex;align-items:center;gap:4px;font-size:12px;font-weight:500;color:#dc2626;cursor:pointer}
    .lane h3 .broken-check input{cursor:pointer;width:14px;height:14px}
    .lane .count{color:var(--mut);font-weight:500;margin-left:6px}
    .lane .drop{flex:1;padding:10px;display:flex;flex-direction:column;gap:10px;min-height:120px}
    .lane .drop.dragover{outline:2px dashed #9bb7ff;outline-offset:-6px}
    
    /* ì¹´ë“œ ìƒíƒœë³„ ë°°ê²½ìƒ‰ */
    .wcard{background:#fff;border:1px solid var(--bd);border-radius:8px;padding:10px;cursor:grab;box-shadow:0 1px 0 rgba(0,0,0,.03);width:240px;transition:background .2s}
    .wcard.wait{background:var(--wait);border-color:#fde047}
    .wcard.progress{background:var(--progress);border-color:#86efac}
    .wcard.done{background:var(--done);border-color:#93c5fd}
    .wcard:active{cursor:grabbing}
    .wcard .title{font-weight:700;margin-bottom:6px}
    .wcard .title-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
    .wcard .urgency{margin-left:auto;display:flex;gap:2px;font-size:16px;line-height:1}
    .wcard .urgency .icon{filter: drop-shadow(0 0 1px rgba(0,0,0,.2))}
    .wcard.urgent-blink{animation: urgentBlink .6s ease-in-out 5}
    @keyframes urgentBlink{
      0%,100% { background:#fff; border-color: var(--bd); }
      50%     { background:#fecaca; border-color:#ef4444; }
    }
    .wcard .meta{display:flex;gap:6px;color:var(--mut);font-size:12px;margin-bottom:6px}
    .wcard .status-sel{display:flex;gap:4px;margin-top:8px;flex-wrap:wrap}
    .wcard .status-sel button{padding:4px 8px;border:1px solid var(--bd);border-radius:6px;background:#fff;cursor:pointer;font-size:11px}
    .wcard .status-sel button.on{background:#3b82f6;border-color:#3b82f6;color:#fff;font-weight:600}
    .empty{color:var(--mut);font-size:13px;text-align:center;padding:20px}
    
    /* ëª¨ë‹¬ */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:50;padding:20px}
    .modal.show{display:flex}
    .modal .panel{background:#fff;border:1px solid var(--bd);border-radius:12px;width:min(600px,90%);max-height:80vh;overflow:auto;padding:20px}
    .modal h2{margin:0 0 14px}
    .modal .close{float:right;padding:4px 10px;border:1px solid var(--bd);border-radius:8px;background:#fff;cursor:pointer}
    .modal .row{display:grid;grid-template-columns:120px 1fr;gap:10px;margin:10px 0;padding:10px 0;border-bottom:1px solid #f3f4f6;align-items:center}
    .modal .row:last-child{border-bottom:none}
    .modal .label{font-weight:600;color:var(--mut)}
    .modal input[type="text"],.modal input[type="number"],.modal input[type="datetime-local"]{
      width:100%;height:34px;padding:6px 10px;border:1px solid var(--bd);border-radius:6px;font-size:14px
    }
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
    .modal .info-text{color:var(--mut);font-size:13px;margin-top:8px;line-height:1.5}
  </style>
</head>
<body>
  <!-- ê³ ì • í—¤ë” -->
  <header class="fixed-header"></header>

  <main>
    <div class="tabs" id="tabs"></div>
    
    <!-- í˜„ì¬ ê³µì •ì˜ ì˜¤ëŠ˜ ì™„ë£Œëœ ì‘ì—… -->
    <div class="today-completed" id="todayCompletedSection" style="display:none">
      <h3><span id="todayProcessLabel"></span> ì˜¤ëŠ˜ ì™„ë£Œ <span class="count" id="todayCount">(0)</span></h3>
      <div class="list" id="todayList"></div>
    </div>
    
    <section id="boards"></section>
  </main>

  <!-- ì™„ë£Œ ì¹´ë“œ ìƒì„¸/ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="editModal" class="modal">
    <div class="panel">
      <button class="close" onclick="document.getElementById('editModal').classList.remove('show')">ë‹«ê¸°</button>
      <h2>ì‘ì—… ìƒì„¸</h2>
      <div id="editContent"></div>
    </div>
  </div>

  <!-- ìµœì¢… ìˆ˜ëŸ‰ ì…ë ¥ ëª¨ë‹¬ -->
  <div id="finalQtyModal" class="modal">
    <div class="panel">
      <h2>ìƒì‚° ì™„ë£Œ</h2>
      <div class="row">
        <div class="label">ì œí’ˆëª…</div>
        <div id="finalProductName">-</div>
      </div>
      <div class="row">
        <div class="label">ì£¼ë¬¸ ìˆ˜ëŸ‰</div>
        <div id="finalOrderQty">-</div>
      </div>
      <div class="row">
        <div class="label">ìµœì¢… ìƒì‚° ìˆ˜ëŸ‰</div>
        <input type="number" id="finalQtyInput" class="inp" min="0" placeholder="ì‹¤ì œ ìƒì‚°ëœ ìˆ˜ëŸ‰ ì…ë ¥">
      </div>
      <p class="info-text">â€» ì…ë ¥í•œ ìˆ˜ëŸ‰ì´ ì¬ê³ ë¡œ ë“±ë¡ë©ë‹ˆë‹¤.</p>
      <div class="actions">
        <button class="btn" onclick="closeFinalQtyModal()">ì·¨ì†Œ</button>
        <button class="btn primary" onclick="confirmFinalQty()">ì™„ë£Œ ë° ì¬ê³  ë“±ë¡</button>
      </div>
    </div>
  </div>

  <script src="assets/nav.js"></script>
  <script>
  ;(()=>{
    const $=s=>document.querySelector(s);
    const $$=s=>Array.from(document.querySelectorAll(s));

    function getCurrentUser(){
      try{
        const authData = localStorage.getItem('sepnp_auth');
        if(authData){
          const parsed = JSON.parse(authData);
          return parsed.user?.name || 'ê´€ë¦¬ì';
        }
      }catch(e){}
      return 'ê´€ë¦¬ì';
    }

    const currentUserName = getCurrentUser();

    const CATS = [
      { id:'print',      label:'ì¸ì‡„',    machines:['1í˜¸ê¸°','2í˜¸ê¸°','3í˜¸ê¸°'] },
      { id:'coating',    label:'ì½”íŒ…',    machines:['ì˜¤ë²„ì½”íŒ…1í˜¸ê¸°','ì˜¤ë²„ì½”íŒ…2í˜¸ê¸°','ì˜¤ë²„ì½”íŒ…3í˜¸ê¸°','UVì½”íŒ…ê¸°','ë¼ë¯¸ë„¤ì´íŒ…ê¸°','ì—´ì½”íŒ…ê¸°'] },
      { id:'foil',       label:'ê¸ˆë°•',    machines:['YUYIN1í˜¸ê¸°','YUYIN2í˜¸ê¸°','í•˜ì´ë¸ë² ë¥´ê·¸'] },
      { id:'emboss',     label:'í˜•ì••',    machines:['YUYIN1í˜¸ê¸°','YUYIN2í˜¸ê¸°','í•˜ì´ë¸ë² ë¥´ê·¸'] },
      { id:'lamination', label:'í•©ì§€',    machines:['í•©ì§€ê¸°1','í•©ì§€í†°ìŠ¨ê¸°1'] },
      { id:'thomson',    label:'í†°ìŠ¨',    machines:['1í˜¸ê¸°','2í˜¸ê¸°','3í˜¸ê¸°','4í˜¸ê¸°','5í˜¸ê¸°'] },
      { id:'adhesive',   label:'ì ‘ì°©',    machines:['1í˜¸ê¸°','2í˜¸ê¸°','3í˜¸ê¸°','4í˜¸ê¸°','5í˜¸ê¸°','6í˜¸ê¸°','7í˜¸ê¸°'] }
    ];

    const KEY='sepnp_workstatus_v6';
    const state = load() || bootstrap();
    let currentCat = CATS[0].id;
    let pendingFinalCard = null; // ìµœì¢… ìˆ˜ëŸ‰ ì…ë ¥ ëŒ€ê¸° ì¤‘ì¸ ì¹´ë“œ

    function bootstrap(){
      const lanes={};
      const completed={};
      const brokenMachines = {};
      CATS.forEach(cat=>{
        lanes[`${cat.id}::pool`]=[];
        cat.machines.forEach((m,idx)=> lanes[`${cat.id}::m${idx+1}`]=[]);
        completed[cat.id]=[];
        brokenMachines[cat.id] = {};
      });
      return { lanes, completed, brokenMachines, seq:0 };
    }
    function load(){
      try{
        const raw=localStorage.getItem(KEY); if(!raw) return null;
        const s=JSON.parse(raw);
        if(!s.completed || Array.isArray(s.completed)){
          const old = s.completed || [];
          s.completed={};
          CATS.forEach(cat=>s.completed[cat.id]=[]);
          if(old.length) s.completed[CATS[0].id]=old;
        }
        if(!s.brokenMachines) s.brokenMachines = {};
        CATS.forEach(cat=>{
          if(!s.lanes[`${cat.id}::pool`]) s.lanes[`${cat.id}::pool`]=[];
          cat.machines.forEach((m,idx)=>{
            const k=`${cat.id}::m${idx+1}`; if(!s.lanes[k]) s.lanes[k]=[];
          });
          if(!s.completed[cat.id]) s.completed[cat.id]=[];
          if(!s.brokenMachines[cat.id]) s.brokenMachines[cat.id] = {};
        });
        return s;
      }catch(e){ console.error(e); return null; }
    }
    function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

    function isToday(ts){
      if(!ts) return false;
      const d = new Date(ts);
      const today = new Date();
      return d.toDateString() === today.toDateString();
    }

    function toDatetimeLocal(ts){
      if(!ts) return '';
      const d=new Date(ts);
      const pad=n=>String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    const PROC_ORDER = ['print','coating','foil','emboss','lamination','thomson','adhesive'];

    function getNextCatId(card, currentCatId){
      const route = Array.isArray(card?.route) ? card.route.slice() : PROC_ORDER.slice();
      const idx = route.indexOf(currentCatId);
      if(idx >= 0 && idx < route.length-1) return route[idx+1];
      const i2 = PROC_ORDER.indexOf(currentCatId);
      return (i2 >= 0 && i2 < PROC_ORDER.length-1) ? PROC_ORDER[i2+1] : null;
    }

    function isLastProcess(card, currentCatId){
      return !getNextCatId(card, currentCatId);
    }

    // ì¬ê³  ë“±ë¡
    function addToInventory(productName, qty, unit, spec){
      const KEY_PRODUCTS = 'sepnp_inventory_products';
      let products = [];
      try{
        products = JSON.parse(localStorage.getItem(KEY_PRODUCTS) || '[]');
      }catch(e){}

      // ë™ì¼ ì œí’ˆëª… ì°¾ê¸°
      let product = products.find(p => p.name === productName);
      if(!product){
        // ì‹ ê·œ ì œí’ˆ ì¶”ê°€
        product = {
          id: `prod_${Date.now()}`,
          name: productName,
          length: spec?.length || 0,
          width: spec?.width || 0,
          height: spec?.height || 0,
          vendor: '',
          qty: 0,
          safety: 0,
          unit: unit || 'ê°œ',
          lastIn: new Date().toISOString().slice(0,10)
        };
        products.push(product);
      }

      product.qty = (product.qty || 0) + qty;
      product.unit = product.unit || unit || 'ê°œ';
      product.lastIn = new Date().toISOString().slice(0,10);

      localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products));
    }

    // ìµœì¢… ìˆ˜ëŸ‰ ëª¨ë‹¬ ì—´ê¸°
    window.showFinalQtyModal = function(card, catId){
      pendingFinalCard = { card, catId };
      $('#finalProductName').textContent = card.title || 'ì œí’ˆ';
      $('#finalOrderQty').textContent = `${card.qty || 0}ê°œ`;
      $('#finalQtyInput').value = card.qty || 0;
      $('#finalQtyModal').classList.add('show');
      $('#finalQtyInput').focus();
    };

    window.closeFinalQtyModal = function(){
      $('#finalQtyModal').classList.remove('show');
      pendingFinalCard = null;
    };

    window.confirmFinalQty = function(){
      if(!pendingFinalCard) return;
      
      const finalQty = parseInt($('#finalQtyInput').value || '0', 10);
      if(!finalQty || finalQty < 0){
        alert('ìµœì¢… ìƒì‚° ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }

      const { card, catId } = pendingFinalCard;
      
      // ì¬ê³  ë“±ë¡
      addToInventory(
        card.title,
        finalQty,
        'ê°œ',
        { length: 0, width: 0, height: 0 }
      );

      // ì™„ë£Œ ì²˜ë¦¬
      card.finalQty = finalQty;
      card.completedAt = Date.now();
      card.completedBy = currentUserName;
      if(!card.startedAt){
        card.startedAt = Date.now();
        card.startedBy = currentUserName;
      }

      const loc = findCardLocation(card.id);
      if(loc){
        const [removed] = state.lanes[loc.key].splice(loc.index, 1);
        if(!state.completed[catId]) state.completed[catId] = [];
        state.completed[catId].unshift(removed);
        
        refreshLane(loc.key, catId);
        renderTodayCompleted(catId);
        save();
      }

      closeFinalQtyModal();
      alert(`ìƒì‚° ì™„ë£Œ! ì¬ê³ ì— ${finalQty}ê°œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    };

    function renderTodayCompleted(catId){
      currentCat = catId;
      const todayCards = (state.completed[catId]||[]).filter(c=>isToday(c.completedAt));
      const section = $('#todayCompletedSection');
      const list = $('#todayList');
      const count = $('#todayCount');
      const label = $('#todayProcessLabel');
      
      const cat = CATS.find(c=>c.id===catId);
      label.textContent = cat ? cat.label : '';
      
      if(!todayCards.length){
        section.style.display='none';
        return;
      }
      
      section.style.display='block';
      count.textContent=`(${todayCards.length})`;
      list.innerHTML='';
      
      todayCards.forEach(card=>{
        const mini = document.createElement('div');
        mini.className='mini-card';
        const finalText = card.finalQty ? ` â†’ ìƒì‚° ${card.finalQty}ê°œ` : '';
        mini.textContent=`${card.title} - ${card.vendor||''} (${card.qty??0})${finalText}`;
        mini.addEventListener('click', ()=>showEditModal(card, catId));
        list.appendChild(mini);
      });
    }

    function showEditModal(card, catId){
      const modal = $('#editModal');
      const content = $('#editContent');
      
      content.innerHTML=`
        <div class="row">
          <div class="label">ì œí’ˆëª…</div>
          <input type="text" id="editTitle" value="${card.title||''}">
        </div>
        <div class="row">
          <div class="label">ê±°ë˜ì²˜</div>
          <input type="text" id="editVendor" value="${card.vendor||''}">
        </div>
        <div class="row">
          <div class="label">ìˆ˜ëŸ‰</div>
          <input type="number" id="editQty" value="${card.qty??0}">
        </div>
        ${card.finalQty ? `
        <div class="row">
          <div class="label">ìµœì¢… ìƒì‚°ëŸ‰</div>
          <div>${card.finalQty}ê°œ</div>
        </div>
        ` : ''}
        <div class="row">
          <div class="label">ì‘ì—… ì‹œì‘</div>
          <input type="datetime-local" id="editStart" value="${toDatetimeLocal(card.startedAt)}">
        </div>
        <div class="row">
          <div class="label">ì‹œì‘ ì‘ì—…ì</div>
          <input type="text" id="editStartedBy" value="${card.startedBy||''}">
        </div>
        <div class="row">
          <div class="label">ì‘ì—… ì¢…ë£Œ</div>
          <input type="datetime-local" id="editEnd" value="${toDatetimeLocal(card.completedAt)}">
        </div>
        <div class="row">
          <div class="label">ì¢…ë£Œ ì‘ì—…ì</div>
          <input type="text" id="editCompletedBy" value="${card.completedBy||''}">
        </div>
        <div class="actions">
          <button class="btn danger" id="btnDelete">ì‚­ì œ</button>
          <button class="btn primary" id="btnSave">ì €ì¥</button>
        </div>
      `;

      $('#btnSave').addEventListener('click', ()=>{
        card.title = $('#editTitle').value.trim();
        card.vendor = $('#editVendor').value.trim();
        card.qty = +$('#editQty').value || 0;
        const startVal = $('#editStart').value;
        const endVal = $('#editEnd').value;
        card.startedAt = startVal ? new Date(startVal).getTime() : card.startedAt;
        card.completedAt = endVal ? new Date(endVal).getTime() : card.completedAt;
        card.startedBy = $('#editStartedBy').value.trim();
        card.completedBy = $('#editCompletedBy').value.trim();
        save();
        renderTodayCompleted(catId);
        modal.classList.remove('show');
        alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      });

      $('#btnDelete').addEventListener('click', ()=>{
        if(!confirm('ì´ ì‘ì—…ì„ ì‚­ì œí• ê¹Œìš”?')) return;
        const idx = state.completed[catId].findIndex(c=>c.id===card.id);
        if(idx>-1) state.completed[catId].splice(idx,1);
        save();
        renderTodayCompleted(catId);
        modal.classList.remove('show');
      });

      modal.classList.add('show');
    }

    function renderTabs(){
      const tabs=$('#tabs'); tabs.innerHTML='';
      CATS.forEach((c,i)=>{
        const btn=document.createElement('button');
        btn.className='tab'+(i===0?' active':'');
        btn.textContent=c.label;
        btn.dataset.cat=c.id;
        btn.addEventListener('click',()=>{
          $$('.tab').forEach(t=>t.classList.remove('active'));
          btn.classList.add('active');
          showBoard(c.id);
          renderTodayCompleted(c.id);
        });
        tabs.appendChild(btn);
      });
    }

    function showBoard(catId){
      const boards=$('#boards'); boards.innerHTML='';
      boards.appendChild(buildBoard(catId));
    }

    function buildBoard(catId){
      const sec=document.createElement('div'); sec.className='board active';
      sec.appendChild(buildPoolLane(catId));
      const machineWrap=document.createElement('div'); machineWrap.className='machine-lanes';
      const cat=CATS.find(c=>c.id===catId);
      cat.machines.forEach((name,idx)=>{
        machineWrap.appendChild(buildLane(catId,`m${idx+1}`,name));
      });
      sec.appendChild(machineWrap);
      return sec;
    }

    function buildPoolLane(catId){
      const k=`${catId}::pool`;
      const wrap=document.createElement('div'); wrap.className='pool-lane';
      const h=document.createElement('h3');
      h.innerHTML=`ëŒ€ê¸°í’€ <span class="count">(${state.lanes[k].length})</span>`;
      wrap.appendChild(h);

      const drop=document.createElement('div');
      drop.className='drop';
      drop.dataset.key=k;
      addDnd(drop);
      wrap.appendChild(drop);

      if(!state.lanes[k].length){
        const emp=document.createElement('div'); emp.className='empty'; emp.textContent='ì¹´ë“œ ì—†ìŒ';
        drop.appendChild(emp);
      }else{
        state.lanes[k].forEach(card=> drop.appendChild(cardEl(card, catId)));
      }
      return wrap;
    }

    function buildLane(catId, laneId, title){
      const k=`${catId}::${laneId}`;
      const wrap=document.createElement('div'); 
      wrap.className='lane';
      wrap.dataset.key = k;
      
      const isBroken = state.brokenMachines[catId] && state.brokenMachines[catId][laneId];
      if(isBroken) wrap.classList.add('broken');

      const h=document.createElement('h3');
      h.innerHTML=`
        <div class="title-left">
          <span>${title}</span>
          <span class="count">(${state.lanes[k].length})</span>
        </div>
        <label class="broken-check" onclick="event.stopPropagation()">
          <input type="checkbox" data-cat="${catId}" data-lane="${laneId}" ${isBroken?'checked':''}>
          ê³ ì¥
        </label>
      `;
      wrap.appendChild(h);

      const checkbox = h.querySelector('input[type="checkbox"]');
      checkbox.addEventListener('change', (e)=>{
        e.stopPropagation();
        const checked = checkbox.checked;
        if(!state.brokenMachines[catId]) state.brokenMachines[catId] = {};
        state.brokenMachines[catId][laneId] = checked;
        
        if(checked){
          wrap.classList.add('broken');
        }else{
          wrap.classList.remove('broken');
        }
        
        save();
      });

      const drop=document.createElement('div');
      drop.className='drop';
      drop.dataset.key=k;
      addDnd(drop);
      wrap.appendChild(drop);

      if(!state.lanes[k].length){
        const emp=document.createElement('div'); emp.className='empty'; emp.textContent='ì¹´ë“œ ì—†ìŒ';
        drop.appendChild(emp);
      }else{
        state.lanes[k].forEach(card=> drop.appendChild(cardEl(card, catId)));
      }
      return wrap;
    }

    function parseDue(d){
      if(!d) return null;
      if(typeof d==='number') return new Date(d);
      if(typeof d==='string'){
        const s = d.includes('T') ? d : `${d}T23:59:59`;
        const dt = new Date(s);
        return isNaN(dt) ? null : dt;
      }
      return null;
    }
    function daysUntilDue(due){
      const dueDt = parseDue(due);
      if(!dueDt) return Infinity;
      const today = new Date();
      today.setHours(0,0,0,0);
      return Math.ceil((dueDt - today)/86400000);
    }
    function getUrgency(due){
      const dl = daysUntilDue(due);
      if(dl === 3) return { icons:1, blink:false, days:dl };
      if(dl === 2) return { icons:2, blink:false, days:dl };
      if(dl <= 1) return { icons:1, blink:true,  days:dl };
      return { icons:0, blink:false, days:dl };
    }

    function findCardLocation(cardId){
      for(const [key, arr] of Object.entries(state.lanes)){
        const idx = arr.findIndex(c => c.id === cardId);
        if(idx > -1) return { key, index: idx };
      }
      return null;
    }

    function refreshLane(key, catId){
      const drop = document.querySelector(`.drop[data-key="${key}"]`);
      if(!drop) return;
      const arr = state.lanes[key] || [];
      drop.innerHTML = '';
      if(arr.length === 0){
        const emp = document.createElement('div');
        emp.className = 'empty';
        emp.textContent = 'ì¹´ë“œ ì—†ìŒ';
        drop.appendChild(emp);
      }else{
        arr.forEach(card => drop.appendChild(cardEl(card, catId)));
      }
      const countEl = drop.parentElement?.querySelector('h3 .count');
      if(countEl) countEl.textContent = `(${arr.length})`;
    }

    function addDnd(dropEl){
      dropEl.addEventListener('dragover', e=>{
        const laneEl = dropEl.closest('.lane');
        if(laneEl && laneEl.classList.contains('broken')) return;
        
        e.preventDefault();
        dropEl.classList.add('dragover');
      });
      dropEl.addEventListener('dragleave', ()=>{
        dropEl.classList.remove('dragover');
      });
      dropEl.addEventListener('drop', e=>{
        e.preventDefault();
        dropEl.classList.remove('dragover');

        const laneEl = dropEl.closest('.lane');
        if(laneEl && laneEl.classList.contains('broken')) return;

        const targetKey = dropEl.dataset.key;
        if(!targetKey) return;
        const targetCat = targetKey.split('::')[0];

        const id = e.dataTransfer.getData('text/plain');
        if(!id) return;

        const loc = findCardLocation(id);
        if(!loc) return;
        if(loc.key === targetKey) return;

        const [card] = state.lanes[loc.key].splice(loc.index, 1);

        if(targetKey.endsWith('::pool')){
          card.status = 'wait';
        }else{
          card.status = 'progress';
          if(!card.startedAt) {
            card.startedAt = Date.now();
            card.startedBy = currentUserName;
          }
        }

        state.lanes[targetKey].push(card);

        refreshLane(loc.key, loc.key.split('::')[0]);
        refreshLane(targetKey, targetCat);
        save();
      });
    }

    function cardEl(card, catId){
      if(!card.status) card.status='wait';
      const el=document.createElement('div');
      el.className=`wcard ${card.status}`;
      el.draggable=true;
      el.dataset.id=card.id;
      el.innerHTML=`
        <div class="title-row">
          <div class="title">${card.title}</div>
          <div class="urgency" aria-label="due-indicator"></div>
        </div>
        <div class="meta">
          <span>${card.vendor||''}</span>
          <span>Â·</span>
          <span>ìˆ˜ëŸ‰ ${card.qty??0}</span>
        </div>
        <div class="status-sel">
          <button data-status="wait" class="${card.status==='wait'?'on':''}">ëŒ€ê¸°</button>
          <button data-status="progress" class="${card.status==='progress'?'on':''}">ì§„í–‰ì¤‘</button>
          <button data-status="done" class="${card.status==='done'?'on':''}">ì™„ë£Œ</button>
        </div>
      `;

      const u = getUrgency(card.dueDate);
      const urgEl = el.querySelector('.urgency');
      if(u.icons > 0){
        urgEl.textContent = 'ğŸš¨'.repeat(u.icons);
        if(card.dueDate){
          const sign = u.days >= 0 ? 'D-' : 'D+';
          urgEl.title = `ë‚©ê¸° ${sign}${Math.abs(u.days)}`;
        }
      }
      el.classList.toggle('urgent-blink', !!u.blink);

      el.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('text/plain', card.id);
        setTimeout(()=> el.classList.add('dragging'),0);
      });
      el.addEventListener('dragend', ()=> el.classList.remove('dragging'));

      el.querySelectorAll('[data-status]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          e.stopPropagation();
          const newStatus=btn.dataset.status;
          const oldStatus=card.status;

          if(newStatus==='progress' && oldStatus!=='progress'){
            card.startedAt=Date.now();
            card.startedBy=currentUserName;
          }
          if(newStatus==='done' && oldStatus!=='done'){
            // ë§ˆì§€ë§‰ ê³µì •ì¸ì§€ í™•ì¸
            if(isLastProcess(card, catId)){
              // ìµœì¢… ìˆ˜ëŸ‰ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
              showFinalQtyModal(card, catId);
              return;
            }

            // ì¤‘ê°„ ê³µì •: ë‹¤ìŒ ê³µì •ìœ¼ë¡œ ìë™ ì´ë™
            card.completedAt=Date.now();
            card.completedBy=currentUserName;
            if(!card.startedAt){
              card.startedAt=Date.now();
              card.startedBy=currentUserName;
            }
            const loc=findCardLocation(card.id);
            if(loc){
              const [removed]=state.lanes[loc.key].splice(loc.index,1);
              const curCatId = catId;
              if(!state.completed[curCatId]) state.completed[curCatId]=[];
              state.completed[curCatId].unshift(removed);

              const nextCat = getNextCatId(removed, curCatId);
              if(nextCat){
                const poolKey = `${nextCat}::pool`;
                if(!Array.isArray(state.lanes[poolKey])) state.lanes[poolKey]=[];
                const nextCard = {
                  ...removed,
                  status:'wait',
                  startedAt:null,
                  completedAt:null,
                  startedBy:null,
                  completedBy:null,
                  currentCat: nextCat
                };
                state.lanes[poolKey].unshift(nextCard);
                refreshLane(poolKey, nextCat);
              }

              refreshLane(loc.key, curCatId);
              renderTodayCompleted(curCatId);
              save();
              return;
            }
          }

          card.status=newStatus;
          save();
          el.className=`wcard ${newStatus}`;
          el.querySelectorAll('[data-status]').forEach(b=>b.classList.toggle('on', b.dataset.status===newStatus));
        });
      });

      return el;
    }

    function repaintUrgency(){
      document.querySelectorAll('.wcard').forEach(el=>{
        const id = el.dataset.id;
        const loc = findCardLocation(id);
        if(!loc) return;
        const card = state.lanes[loc.key][loc.index];
        const u = getUrgency(card.dueDate);
        const urgEl = el.querySelector('.urgency');
        if(urgEl){
          urgEl.textContent = u.icons>0 ? 'ğŸš¨'.repeat(u.icons) : '';
          if(card.dueDate){
            const sign = u.days >= 0 ? 'D-' : 'D+';
            urgEl.title = `ë‚©ê¸° ${sign}${Math.abs(u.days)}`;
          }else{
            urgEl.removeAttribute('title');
          }
        }
        el.classList.toggle('urgent-blink', !!u.blink);
      });
    }

    renderTabs();
    showBoard(CATS[0].id);
    renderTodayCompleted(CATS[0].id);
    repaintUrgency();
    setInterval(repaintUrgency, 60000);
  })();
  </script>
</body>
</html>