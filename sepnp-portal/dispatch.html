<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>배차 관리</title>
  <link rel="stylesheet" href="assets/nav.css">
  <style>
    :root{ --bd:#e5e7eb; --fg:#111; --mut:#6b7280; --bg:#f5f6f8; --card:#fff; --primary:#2563eb; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;padding-top:60px}
    .container{max-width:1200px;margin:16px auto;padding:0 12px}
    h2{margin:0 0 12px;font-size:20px;font-weight:800}

    .card{background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:16px;margin-bottom:16px}
    .card h3{margin:0 0 12px;font-size:16px;font-weight:700}

    /* 통계 카드 */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:16px}
    .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:16px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .stat-card.blue{background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%)}
    .stat-card.green{background:linear-gradient(135deg,#10b981 0%,#059669 100%)}
    .stat-card.yellow{background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%)}
    .stat-card.red{background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%)}
    .stat-card .label{font-size:12px;opacity:.9;margin-bottom:4px}
    .stat-card .value{font-size:28px;font-weight:800}

    /* 컴팩트 폼 */
    .form-grid{display:grid;grid-template-columns:repeat(4, 1fr);gap:10px;margin-bottom:12px}
    @media(max-width:1000px){ .form-grid{grid-template-columns:repeat(2, 1fr)} }
    @media(max-width:600px){ .form-grid{grid-template-columns:1fr} }
    
    .form-row{display:flex;flex-direction:column;gap:4px}
    .form-row label{font-size:12px;font-weight:600;color:#374151}
    .form-row.span2{grid-column:span 2}
    .form-row.span4{grid-column:span 4}
    @media(max-width:1000px){ 
      .form-row.span2{grid-column:span 2}
      .form-row.span4{grid-column:span 2}
    }
    @media(max-width:600px){ 
      .form-row.span2,.form-row.span4{grid-column:span 1}
    }

    .inp,.sel,.btn,textarea{border:1px solid var(--bd);border-radius:6px;font-size:13px}
    .inp,.sel{height:34px;padding:0 10px;background:#fff;width:100%}
    textarea{padding:10px;min-height:60px;width:100%;resize:vertical}
    .btn{height:34px;padding:0 14px;background:#fff;cursor:pointer;font-weight:600}
    .btn:hover{background:#f3f4f6}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.secondary{background:#10b981;border-color:#10b981;color:#fff}
    .btn.danger{background:#ef4444;border-color:#ef4444;color:#fff}
    .btn.sm{height:28px;padding:0 10px;font-size:12px}
    .btn.icon{width:28px;height:28px;padding:0;display:inline-flex;align-items:center;justify-content:center;font-size:16px;line-height:1}
    
    .info-box{background:#f9fafb;border:1px solid #e5e7eb;border-radius:6px;padding:8px;margin-top:4px;font-size:13px}
    .info-box strong{font-size:16px;color:#111}
    .info-box .mut{color:var(--mut);font-size:12px;margin-left:4px}

    .actions{display:flex;gap:6px;justify-content:flex-end;margin-top:8px}
    .note{color:var(--mut);font-size:11px;margin-top:8px;line-height:1.4}

    /* 셀렉트 + 버튼 */
    .select-with-add{display:flex;gap:4px;align-items:center}
    .select-with-add select{flex:1}
    .select-with-add .inp{flex:1}

    /* 모달 */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:100;padding:20px}
    .modal.show{display:flex}
    .modal-content{background:#fff;border-radius:10px;width:min(500px,90%);padding:20px;box-shadow:0 4px 24px rgba(0,0,0,.2);max-height:90vh;overflow-y:auto}
    .modal-content h3{margin:0 0 12px;font-size:16px}
    .modal-content .form-row{margin-bottom:10px}
    .modal-content .actions{margin-top:12px}

    /* 테이블 */
    .toolbar{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .table-wrap{border:1px solid var(--bd);border-radius:8px;overflow:auto}
    table{width:100%;border-collapse:collapse;background:#fff;font-size:13px}
    thead{background:#f8f9fa}
    th,td{padding:8px 10px;border-bottom:1px solid #f1f3f5;white-space:nowrap;text-align:center}
    th{font-weight:600}
    tbody tr:hover{background:#fbfcfd}
    
    /* 정렬 */
    .align-right{text-align:right}
    
    /* 상태 배지 */
    .status{padding:3px 8px;border-radius:999px;font-size:11px;font-weight:700;display:inline-block;min-width:50px;text-align:center}
    .status.wait{background:#fef3c7;color:#92400e}
    .status.progress{background:#dbeafe;color:#1e40af}
    .status.done{background:#d1fae5;color:#065f46}
    .status.cancel{background:#fee2e2;color:#991b1b}

    /* 상태 변경 드롭다운 */
    .status-dropdown{position:relative;display:inline-block}
    .status-dropdown select{height:24px;padding:0 6px;font-size:11px;font-weight:700;border-radius:999px;cursor:pointer;min-width:60px;text-align:center}
  </style>
</head>
<body>
  <header class="fixed-header"></header>

  <main class="container">
    <h2>배차 관리</h2>

    <!-- 통계 -->
    <div class="stats-grid">
      <div class="stat-card blue">
        <div class="label">오늘 배차</div>
        <div class="value" id="statToday">0</div>
      </div>
      <div class="stat-card yellow">
        <div class="label">진행 중</div>
        <div class="value" id="statProgress">0</div>
      </div>
      <div class="stat-card green">
        <div class="label">완료</div>
        <div class="value" id="statDone">0</div>
      </div>
      <div class="stat-card red">
        <div class="label">취소</div>
        <div class="value" id="statCancel">0</div>
      </div>
    </div>

    <!-- 배차 등록 -->
    <section class="card">
      <h3>배차 등록</h3>
      
      <div class="form-grid">
        <div class="form-row span2">
          <label>제품 선택</label>
          <select id="productSel" class="sel"></select>
        </div>

        <div class="form-row">
          <label>배차일</label>
          <input id="shipDate" class="inp" type="date">
        </div>

        <div class="form-row">
          <label>출고 수량</label>
          <input id="qtyOut" class="inp" type="number" min="1" placeholder="수량">
        </div>

        <div class="form-row span4">
          <label>현재 재고</label>
          <div class="info-box">
            <strong id="stockNow">-</strong>
            <span class="mut" id="unitNow"></span>
            <span class="mut" id="specNow"></span>
          </div>
        </div>

        <div class="form-row span2">
          <label>거래처</label>
          <div class="select-with-add">
            <select id="customerSel" class="sel">
              <option value="">-- 선택 --</option>
            </select>
            <button class="btn icon secondary" onclick="showCustomerModal()" title="거래처 추가">+</button>
          </div>
        </div>

        <div class="form-row span2">
          <label>배송지</label>
          <div class="select-with-add">
            <select id="destSel" class="sel">
              <option value="">-- 선택 --</option>
            </select>
            <button class="btn icon secondary" onclick="showDestModal()" title="배송지 추가">+</button>
          </div>
        </div>

        <div class="form-row">
          <label>차량</label>
          <div class="select-with-add">
            <select id="vehicleSel" class="sel">
              <option value="">-- 선택 --</option>
            </select>
            <button class="btn icon secondary" onclick="showVehicleModal()" title="차량/기사 추가">+</button>
          </div>
        </div>

        <div class="form-row">
          <label>기사</label>
          <div class="select-with-add">
            <select id="driverSel" class="sel">
              <option value="">-- 선택 --</option>
            </select>
            <button class="btn icon secondary" onclick="showVehicleModal()" title="차량/기사 추가">+</button>
          </div>
        </div>

        <div class="form-row span2">
          <label>메모</label>
          <textarea id="memo" placeholder="전달사항, 특이사항 등"></textarea>
        </div>
      </div>

      <div class="actions">
        <button id="btnReset" class="btn sm">초기화</button>
        <button id="btnRegister" class="btn sm primary" data-perm="dispatch.create">배차 등록</button>
      </div>
      
      <p class="note">※ 배차 등록 시 해당 제품 재고가 즉시 차감됩니다. (취소 시 재고 복원)</p>
    </section>

    <!-- 배차 내역 -->
    <section class="card">
      <h3>배차 내역</h3>
      <div class="toolbar">
        <input id="q" class="inp" style="flex:1;min-width:180px" placeholder="제품명/거래처/배송지 검색">
        <input id="from" class="inp" type="date" style="width:130px">
        <span class="mut">~</span>
        <input id="to" class="inp" type="date" style="width:130px">
        <select id="st" class="sel" style="width:100px">
          <option value="">전체</option>
          <option value="wait">대기</option>
          <option value="progress">진행</option>
          <option value="done">완료</option>
          <option value="cancel">취소</option>
        </select>
        <button class="btn sm" id="btnSearch">검색</button>
        <button class="btn sm" id="btnExport">CSV</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>배차일</th>
              <th>제품명</th>
              <th>규격</th>
              <th>거래처</th>
              <th>배송지</th>
              <th class="align-right">수량</th>
              <th>차량</th>
              <th>기사</th>
              <th>상태</th>
              <th>관리</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- 차량/기사 등록 모달 -->
  <div id="vehicleModal" class="modal">
    <div class="modal-content">
      <h3>차량·기사 등록</h3>
      <div class="form-row">
        <label>차량번호 / 차종</label>
        <input id="newVehicle" class="inp" placeholder="예: 12가3456 / 1톤">
      </div>
      <div class="form-row">
        <label>기사명</label>
        <input id="newDriver" class="inp" placeholder="예: 홍길동">
      </div>
      <div class="actions">
        <button class="btn sm" onclick="closeVehicleModal()">취소</button>
        <button class="btn sm primary" onclick="addVehicle()">추가</button>
      </div>
    </div>
  </div>

  <!-- 거래처 등록 모달 -->
  <div id="customerModal" class="modal">
    <div class="modal-content">
      <h3>거래처 등록</h3>
      <div class="form-row">
        <label>거래처명</label>
        <input id="newCustomer" class="inp" placeholder="예: ㈜세팍패키지">
      </div>
      <div class="actions">
        <button class="btn sm" onclick="closeCustomerModal()">취소</button>
        <button class="btn sm primary" onclick="addCustomer()">추가</button>
      </div>
    </div>
  </div>

  <!-- 배송지 등록 모달 -->
  <div id="destModal" class="modal">
    <div class="modal-content">
      <h3>배송지 등록</h3>
      <div class="form-row">
        <label>배송지 주소</label>
        <input id="newDest" class="inp" placeholder="예: 서울시 강남구 테헤란로 123">
      </div>
      <div class="actions">
        <button class="btn sm" onclick="closeDestModal()">취소</button>
        <button class="btn sm primary" onclick="addDest()">추가</button>
      </div>
    </div>
  </div>

  <!-- 배차 수정 모달 -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3>배차 수정</h3>
      
      <div class="form-grid">
        <div class="form-row span2">
          <label>제품명</label>
          <input id="editProductName" class="inp" readonly style="background:#f9fafb">
        </div>

        <div class="form-row">
          <label>배차일</label>
          <input id="editDate" class="inp" type="date">
        </div>

        <div class="form-row">
          <label>수량</label>
          <input id="editQty" class="inp" type="number" min="1">
        </div>

        <div class="form-row span2">
          <label>거래처</label>
          <select id="editCustomer" class="sel">
            <option value="">-- 선택 --</option>
          </select>
        </div>

        <div class="form-row span2">
          <label>배송지</label>
          <select id="editDest" class="sel">
            <option value="">-- 선택 --</option>
          </select>
        </div>

        <div class="form-row">
          <label>차량</label>
          <select id="editVehicle" class="sel">
            <option value="">-- 선택 --</option>
          </select>
        </div>

        <div class="form-row">
          <label>기사</label>
          <select id="editDriver" class="sel">
            <option value="">-- 선택 --</option>
          </select>
        </div>

        <div class="form-row">
          <label>상태</label>
          <select id="editStatus" class="sel">
            <option value="wait">대기</option>
            <option value="progress">진행</option>
            <option value="done">완료</option>
          </select>
        </div>

        <div class="form-row span4">
          <label>메모</label>
          <textarea id="editMemo" placeholder="전달사항, 특이사항 등"></textarea>
        </div>
      </div>

      <div class="actions">
        <button class="btn sm danger" data-perm="dispatch.cancel" onclick="cancelDispatchFromEdit()">배차 취소</button>
        <button class="btn sm danger" data-perm="dispatch.delete" onclick="removeDispatchFromEdit()">삭제</button>
        <button class="btn sm" onclick="closeEditModal()">닫기</button>
        <button class="btn sm primary" data-perm="dispatch.edit" onclick="saveEdit()">저장</button>
      </div>
    </div>
  </div>

  <script src="assets/perm.js"></script>
  <script src="assets/nav.js"></script>
  <script>
    const KEY_PRODUCTS  = 'sepnp_inventory_products';
    const KEY_DISPATCH  = 'sepnp_dispatches';
    const KEY_VEHICLES  = 'sepnp_vehicles';
    const KEY_CUSTOMERS = 'sepnp_customers';
    const KEY_DESTS     = 'sepnp_destinations';

    const SAMPLE_PRODUCTS = [
      {id:'p1', name:'화장품 박스', length:200, width:120, height:60, vendor:'세팍패키지', qty:340, safety:100, unit:'개', lastIn:'2025-01-18'},
      {id:'p2', name:'식품 박스',   length:180, width:100, height:80, vendor:'푸드팩',   qty:40,  safety:80,  unit:'개', lastIn:'2025-01-22'},
      {id:'p3', name:'의류 택박스', length:90,  width:60,  height:40, vendor:'어패럴',   qty:12,  safety:50,  unit:'개', lastIn:'2024-12-30'}
    ];

    const $ = s=>document.querySelector(s);
    const fmtNum = v => Number(v||0).toLocaleString();
    const fmtBox = (l,w,h)=>`${fmtNum(l)}×${fmtNum(w)}×${fmtNum(h)}`;
    const today = () => new Date().toISOString().slice(0,10);

    let currentEditId = null;

    function loadProducts(){
      let list = JSON.parse(localStorage.getItem(KEY_PRODUCTS)||'null');
      if(!Array.isArray(list) || !list.length){ list = SAMPLE_PRODUCTS; localStorage.setItem(KEY_PRODUCTS, JSON.stringify(list)); }
      list.forEach(p=>{ if(!p.id) p.id = `${p.name}|${p.length}x${p.width}x${p.height}`; });
      return list;
    }
    function saveProducts(list){ localStorage.setItem(KEY_PRODUCTS, JSON.stringify(list)); }
    function loadDispatch(){ return JSON.parse(localStorage.getItem(KEY_DISPATCH)||'[]'); }
    function saveDispatch(list){ localStorage.setItem(KEY_DISPATCH, JSON.stringify(list)); }
    function loadVehicles(){ return JSON.parse(localStorage.getItem(KEY_VEHICLES)||'[]'); }
    function saveVehicles(list){ localStorage.setItem(KEY_VEHICLES, JSON.stringify(list)); }
    function loadCustomers(){ return JSON.parse(localStorage.getItem(KEY_CUSTOMERS)||'[]'); }
    function saveCustomers(list){ localStorage.setItem(KEY_CUSTOMERS, JSON.stringify(list)); }
    function loadDests(){ return JSON.parse(localStorage.getItem(KEY_DESTS)||'[]'); }
    function saveDests(list){ localStorage.setItem(KEY_DESTS, JSON.stringify(list)); }

    // 통계 업데이트
    function updateStats(){
      const list = loadDispatch();
      const todayStr = today();
      
      const todayCount = list.filter(r => r.date === todayStr && r.status !== 'cancel').length;
      const progressCount = list.filter(r => r.status === 'progress').length;
      const doneCount = list.filter(r => r.status === 'done').length;
      const cancelCount = list.filter(r => r.status === 'cancel').length;

      $('#statToday').textContent = todayCount;
      $('#statProgress').textContent = progressCount;
      $('#statDone').textContent = doneCount;
      $('#statCancel').textContent = cancelCount;
    }

    // 차량/기사 모달
    function showVehicleModal(){
      $('#vehicleModal').classList.add('show');
      $('#newVehicle').value = '';
      $('#newDriver').value = '';
      $('#newVehicle').focus();
    }

    function closeVehicleModal(){
      $('#vehicleModal').classList.remove('show');
    }

    function addVehicle(){
      const vehicle = $('#newVehicle').value.trim();
      const driver = $('#newDriver').value.trim();
      if(!vehicle || !driver){ alert('차량번호와 기사명을 모두 입력하세요.'); return; }
      
      const list = loadVehicles();
      list.push({vehicle, driver});
      saveVehicles(list);
      
      renderVehicleSelects();
      closeVehicleModal();
      
      $('#vehicleSel').value = vehicle;
      $('#driverSel').value = driver;
    }

    function renderVehicleSelects(){
      const list = loadVehicles();
      const vSel = $('#vehicleSel');
      const dSel = $('#driverSel');
      const evSel = $('#editVehicle');
      const edSel = $('#editDriver');
      
      const currentV = vSel?.value;
      const currentD = dSel?.value;
      const editV = evSel?.value;
      const editD = edSel?.value;

      const vOptions = '<option value="">-- 선택 --</option>' + list.map(v=>`<option value="${v.vehicle}">${v.vehicle}</option>`).join('');
      const dOptions = '<option value="">-- 선택 --</option>' + list.map(v=>`<option value="${v.driver}">${v.driver}</option>`).join('');

      if(vSel) vSel.innerHTML = vOptions;
      if(dSel) dSel.innerHTML = dOptions;
      if(evSel) evSel.innerHTML = vOptions;
      if(edSel) edSel.innerHTML = dOptions;

      if(currentV && vSel) vSel.value = currentV;
      if(currentD && dSel) dSel.value = currentD;
      if(editV && evSel) evSel.value = editV;
      if(editD && edSel) edSel.value = editD;
    }

    $('#vehicleSel')?.addEventListener('change', ()=>{
      const veh = $('#vehicleSel').value;
      if(!veh) return;
      const list = loadVehicles();
      const found = list.find(v=>v.vehicle === veh);
      if(found) $('#driverSel').value = found.driver;
    });

    $('#driverSel')?.addEventListener('change', ()=>{
      const drv = $('#driverSel').value;
      if(!drv) return;
      const list = loadVehicles();
      const found = list.find(v=>v.driver === drv);
      if(found) $('#vehicleSel').value = found.vehicle;
    });

    // 거래처 모달
    function showCustomerModal(){
      $('#customerModal').classList.add('show');
      $('#newCustomer').value = '';
      $('#newCustomer').focus();
    }

    function closeCustomerModal(){
      $('#customerModal').classList.remove('show');
    }

    function addCustomer(){
      const customer = $('#newCustomer').value.trim();
      if(!customer){ alert('거래처명을 입력하세요.'); return; }
      
      const list = loadCustomers();
      if(list.includes(customer)){ alert('이미 등록된 거래처입니다.'); return; }
      
      list.push(customer);
      saveCustomers(list);
      
      renderCustomerSelect();
      closeCustomerModal();
      
      $('#customerSel').value = customer;
    }

    function renderCustomerSelect(){
      const list = loadCustomers();
      const sel = $('#customerSel');
      const editSel = $('#editCustomer');
      const current = sel?.value;
      const editCurrent = editSel?.value;

      const options = '<option value="">-- 선택 --</option>' + list.map(c=>`<option value="${c}">${c}</option>`).join('');

      if(sel) sel.innerHTML = options;
      if(editSel) editSel.innerHTML = options;

      if(current && sel) sel.value = current;
      if(editCurrent && editSel) editSel.value = editCurrent;
    }

    // 배송지 모달
    function showDestModal(){
      $('#destModal').classList.add('show');
      $('#newDest').value = '';
      $('#newDest').focus();
    }

    function closeDestModal(){
      $('#destModal').classList.remove('show');
    }

    function addDest(){
      const dest = $('#newDest').value.trim();
      if(!dest){ alert('배송지를 입력하세요.'); return; }
      
      const list = loadDests();
      if(list.includes(dest)){ alert('이미 등록된 배송지입니다.'); return; }
      
      list.push(dest);
      saveDests(list);
      
      renderDestSelect();
      closeDestModal();
      
      $('#destSel').value = dest;
    }

    function renderDestSelect(){
      const list = loadDests();
      const sel = $('#destSel');
      const editSel = $('#editDest');
      const current = sel?.value;
      const editCurrent = editSel?.value;

      const options = '<option value="">-- 선택 --</option>' + list.map(d=>`<option value="${d}">${d}</option>`).join('');

      if(sel) sel.innerHTML = options;
      if(editSel) editSel.innerHTML = options;

      if(current && sel) sel.value = current;
      if(editCurrent && editSel) editSel.value = editCurrent;
    }

    // 제품 선택
    function renderProductSelect(){
      const list = loadProducts();
      $('#productSel').innerHTML = list.map(p => 
        `<option value="${p.id}">${p.name} (재고: ${fmtNum(p.qty)}${p.unit||''})</option>`
      ).join('');
      onProductChange();
    }

    function onProductChange(){
      const id = $('#productSel').value;
      const p = loadProducts().find(x=>x.id===id);
      if(!p){ 
        $('#stockNow').textContent='-'; 
        $('#specNow').textContent=''; 
        $('#unitNow').textContent=''; 
        return; 
      }
      $('#stockNow').textContent = fmtNum(p.qty);
      $('#unitNow').textContent  = p.unit||'';
      $('#specNow').textContent  = ` · ${fmtBox(p.length,p.width,p.height)}`;
      $('#qtyOut').max = p.qty;
      $('#qtyOut').placeholder = `최대 ${fmtNum(p.qty)}`;
    }

    // 등록
    function registerDispatch(){
      if(!Permissions.has('dispatch.create')){ alert('권한이 없습니다.'); return; }
      const id = $('#productSel').value;
      const list = loadProducts();
      const p = list.find(x=>x.id===id);
      if(!p){ alert('제품을 선택하세요.'); return; }

      const qty = parseInt($('#qtyOut').value||'0',10);
      if(!qty || qty<=0){ alert('출고 수량을 입력하세요.'); return; }
      if(qty > p.qty){ alert('재고보다 많은 수량을 출고할 수 없습니다.'); return; }

      const vehicle = $('#vehicleSel').value.trim();
      const driver = $('#driverSel').value.trim();
      const customer = $('#customerSel').value.trim();
      const dest = $('#destSel').value.trim();

      const rec = {
        id: 'd'+Date.now(),
        date: $('#shipDate').value || today(),
        productId: p.id,
        productName: p.name,
        spec: fmtBox(p.length,p.width,p.height),
        qty, unit: p.unit||'',
        customer,
        dest,
        vehicle,
        driver,
        memo: $('#memo').value.trim(),
        status: 'wait',
        createdAt: new Date().toISOString(),
        startedAt: null,
        completedAt: null
      };

      p.qty = (p.qty||0) - qty;
      saveProducts(list);

      const ds = loadDispatch();
      ds.unshift(rec);
      saveDispatch(ds);

      alert('배차가 등록되었습니다.');
      onProductChange();
      renderTable();
      updateStats();
      resetForm(false);
    }

    // 수정 모달
    function showEditModal(id){
      const ds = loadDispatch();
      const rec = ds.find(r=>r.id===id);
      if(!rec){ alert('기록을 찾을 수 없습니다.'); return; }
      
      currentEditId = id;
      
      $('#editProductName').value = `${rec.productName} (${rec.spec})`;
      $('#editDate').value = rec.date;
      $('#editQty').value = rec.qty;
      $('#editCustomer').value = rec.customer || '';
      $('#editDest').value = rec.dest || '';
      $('#editVehicle').value = rec.vehicle || '';
      $('#editDriver').value = rec.driver || '';
      $('#editStatus').value = rec.status === 'cancel' ? 'wait' : rec.status;
      $('#editMemo').value = rec.memo || '';
      
      // 취소된 배차는 상태 변경 불가
      $('#editStatus').disabled = rec.status === 'cancel';
      
      $('#editModal').classList.add('show');
      // 모달 내부 버튼 권한 적용
      Permissions.applyGates($('#editModal'));
    }

    function closeEditModal(){
      currentEditId = null;
      $('#editModal').classList.remove('show');
    }

    function saveEdit(){
      if(!Permissions.has('dispatch.edit')){ alert('권한이 없습니다.'); return; }
      if(!currentEditId){ alert('오류가 발생했습니다.'); return; }
      
      const ds = loadDispatch();
      const rec = ds.find(r=>r.id===currentEditId);
      if(!rec){ alert('기록을 찾을 수 없습니다.'); return; }
      
      if(rec.status === 'cancel'){
        alert('취소된 배차는 수정할 수 없습니다.');
        return;
      }
      
      const newQty = parseInt($('#editQty').value||'0',10);
      if(!newQty || newQty<=0){ alert('수량을 입력하세요.'); return; }
      
      const oldStatus = rec.status;
      const newStatus = $('#editStatus').value;
      
      // 수량이 변경된 경우 재고 조정
      if(newQty !== rec.qty){
        const diff = newQty - rec.qty;
        const list = loadProducts();
        const p = list.find(x=>x.id===rec.productId);
        if(p){
          if(diff > 0 && p.qty < diff){
            alert('재고가 부족합니다.');
            return;
          }
          p.qty = (p.qty||0) - diff;
          saveProducts(list);
        }
      }
      
      // 상태별 타임스탬프 업데이트
      if(newStatus === 'progress' && oldStatus === 'wait'){
        rec.startedAt = new Date().toISOString();
      }
      if(newStatus === 'done' && oldStatus !== 'done'){
        rec.completedAt = new Date().toISOString();
      }
      
      rec.date = $('#editDate').value;
      rec.qty = newQty;
      rec.customer = $('#editCustomer').value.trim();
      rec.dest = $('#editDest').value.trim();
      rec.vehicle = $('#editVehicle').value.trim();
      rec.driver = $('#editDriver').value.trim();
      rec.status = newStatus;
      rec.memo = $('#editMemo').value.trim();
      
      saveDispatch(ds);
      
      alert('수정되었습니다.');
      closeEditModal();
      renderTable();
      updateStats();
      onProductChange();
    }

    function cancelDispatchFromEdit(){
      if(!Permissions.has('dispatch.cancel')){ alert('권한이 없습니다.'); return; }
      if(!currentEditId){ alert('오류가 발생했습니다.'); return; }
      if(!confirm('배차를 취소하고 재고를 복원할까요?')) return;
      
      cancelDispatch(currentEditId);
      closeEditModal();
    }

    function removeDispatchFromEdit(){
      if(!Permissions.has('dispatch.delete')){ alert('권한이 없습니다.'); return; }
      if(!currentEditId){ alert('오류가 발생했습니다.'); return; }
      if(!confirm('이 배차를 삭제할까요?')) return;
      
      removeDispatch(currentEditId);
      closeEditModal();
    }

    // 상태 변경
    function changeStatus(id, newStatus){
      if(!Permissions.has('dispatch.edit')){ alert('권한이 없습니다.'); return; }
      const ds = loadDispatch();
      const rec = ds.find(r=>r.id===id);
      if(!rec){ alert('기록을 찾을 수 없습니다.'); return; }
      
      const oldStatus = rec.status;
      
      // 취소 상태에서는 변경 불가
      if(oldStatus === 'cancel'){
        alert('취소된 배차는 상태를 변경할 수 없습니다.');
        return;
      }

      // 상태별 타임스탬프 업데이트
      if(newStatus === 'progress' && oldStatus === 'wait'){
        rec.startedAt = new Date().toISOString();
      }
      if(newStatus === 'done' && oldStatus !== 'done'){
        rec.completedAt = new Date().toISOString();
      }

      rec.status = newStatus;
      saveDispatch(ds);
      renderTable();
      updateStats();
    }

    function cancelDispatch(id){
      if(!Permissions.has('dispatch.cancel')){ alert('권한이 없습니다.'); return; }
      const ds = loadDispatch();
      const rec = ds.find(r=>r.id===id);
      if(!rec){ alert('기록을 찾을 수 없습니다.'); return; }
      if(rec.status==='cancel'){ alert('이미 취소된 배차입니다.'); return; }

      const list = loadProducts();
      const p = list.find(x=>x.id===rec.productId);
      if(p){ p.qty = (p.qty||0) + (rec.qty||0); saveProducts(list); }

      rec.status='cancel';
      saveDispatch(ds);

      renderTable();
      updateStats();
      onProductChange();
    }

    function removeDispatch(id){
      if(!Permissions.has('dispatch.delete')){ alert('권한이 없습니다.'); return; }
      const ds = loadDispatch();
      const rec = ds.find(r=>r.id===id);
      if(!rec){ alert('기록을 찾을 수 없습니다.'); return; }
      if(rec.status==='done' || rec.status==='progress'){
        if(!confirm('완료/진행 중 기록을 삭제하면 재고 복원이 되지 않습니다. 계속할까요?')) return;
      }
      const next = ds.filter(r=>r.id!==id);
      saveDispatch(next);
      renderTable();
      updateStats();
    }

    function getStatusLabel(status){
      const labels = {
        'wait': '대기',
        'progress': '진행',
        'done': '완료',
        'cancel': '취소'
      };
      return labels[status] || status;
    }

    function renderTable(){
      const q = $('#q').value.trim().toLowerCase();
      const st = $('#st').value;
      const from = $('#from').value;
      const to = $('#to').value;

      let rows = loadDispatch();
      rows = rows.filter(r=>{
        const text = `${r.productName} ${r.customer} ${r.dest} ${r.spec}`.toLowerCase();
        const passQ = !q || text.includes(q);
        const passS = !st || r.status === st;
        const passFrom = !from || r.date >= from;
        const passTo   = !to   || r.date <= to;
        return passQ && passS && passFrom && passTo;
      });

      $('#tbody').innerHTML = rows.map(r=>{
        // 권한 없는 경우 상태 드롭다운 대신 배지 표시
        const canEditStatus = Permissions.has('dispatch.edit') && r.status !== 'cancel';
        const statusDropdown = canEditStatus ? `
          <div class="status-dropdown">
            <select onchange="changeStatus('${r.id}', this.value)" style="background:${getStatusColor(r.status)};color:${getStatusTextColor(r.status)}">
              <option value="wait" ${r.status==='wait'?'selected':''}>대기</option>
              <option value="progress" ${r.status==='progress'?'selected':''}>진행</option>
              <option value="done" ${r.status==='done'?'selected':''}>완료</option>
            </select>
          </div>
        ` : `<span class="status ${r.status}">${getStatusLabel(r.status)}</span>`;

        const editBtn = `<button class="btn sm primary" onclick="showEditModal('${r.id}')" ${Permissions.has('dispatch.edit') ? '' : 'disabled title="권한이 없습니다"'}>수정</button>`;

        return `
        <tr>
          <td>${r.date}</td>
          <td>${r.productName}</td>
          <td>${r.spec}</td>
          <td>${r.customer||'-'}</td>
          <td>${r.dest||'-'}</td>
          <td class="align-right">${fmtNum(r.qty)}${r.unit||''}</td>
          <td>${r.vehicle||'-'}</td>
          <td>${r.driver||'-'}</td>
          <td>${statusDropdown}</td>
          <td>${editBtn}</td>
        </tr>`;
      }).join('');
    }

    function getStatusColor(status){
      const colors = {
        'wait': '#fef3c7',
        'progress': '#dbeafe',
        'done': '#d1fae5',
        'cancel': '#fee2e2'
      };
      return colors[status] || '#fff';
    }

    function getStatusTextColor(status){
      const colors = {
        'wait': '#92400e',
        'progress': '#1e40af',
        'done': '#065f46',
        'cancel': '#991b1b'
      };
      return colors[status] || '#111';
    }

    function exportCSV(){
      const rows = loadDispatch();
      const header = ['배차일','제품명','규격','거래처','배송지','수량','단위','차량','기사','상태','출발시각','완료시각','비고'];
      const body = rows.map(r=>{
        const statusText = getStatusLabel(r.status);
        const startTime = r.startedAt ? new Date(r.startedAt).toLocaleString('ko-KR') : '-';
        const endTime = r.completedAt ? new Date(r.completedAt).toLocaleString('ko-KR') : '-';
        return [r.date,r.productName,r.spec,r.customer||'',r.dest||'',r.qty,r.unit||'',r.vehicle||'',r.driver||'',statusText,startTime,endTime,r.memo||''];
      });
      const csv = [header].concat(body).map(a=>a.map(v=>`"${(v??'').toString().replace(/"/g,'""')}"`).join(',')).join('\r\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `dispatch_${new Date().toISOString().slice(0,10)}.csv`;
      a.click(); URL.revokeObjectURL(a.href);
    }

    function resetForm(hard=true){
      if(hard) $('#productSel').selectedIndex = 0;
      $('#qtyOut').value='';
      $('#customerSel').selectedIndex = 0;
      $('#destSel').selectedIndex = 0;
      $('#vehicleSel').selectedIndex = 0;
      $('#driverSel').selectedIndex = 0;
      $('#memo').value='';
      $('#shipDate').value = today();
      onProductChange();
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      renderVehicleSelects();
      renderCustomerSelect();
      renderDestSelect();
      renderProductSelect();
      $('#shipDate').value = today();
      renderTable();
      updateStats();

      $('#productSel').addEventListener('change', onProductChange);
      $('#btnRegister').addEventListener('click', registerDispatch);
      $('#btnReset').addEventListener('click', ()=>resetForm(false));
      $('#btnExport').addEventListener('click', exportCSV);
      $('#btnSearch').addEventListener('click', renderTable);
      
      ['q','from','to','st'].forEach(id=>{
        const el = document.getElementById(id);
        el && el.addEventListener('change', renderTable);
        if(id==='q') el && el.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); renderTable(); } });
      });

      // 모달 바깥 클릭시 닫기
      $('#vehicleModal').addEventListener('click', e=>{ if(e.target.id === 'vehicleModal') closeVehicleModal(); });
      $('#customerModal').addEventListener('click', e=>{ if(e.target.id === 'customerModal') closeCustomerModal(); });
      $('#destModal').addEventListener('click', e=>{ if(e.target.id === 'destModal') closeDestModal(); });
      $('#editModal').addEventListener('click', e=>{ if(e.target.id === 'editModal') closeEditModal(); });
    });

    window.receiveProduction = function(payload){
      const {id,name,length,width,height,qty,unit} = payload||{};
      if(!name || !qty) return;
      const list = loadProducts();
      let p = list.find(x=> x.id===id) || list.find(x=> x.name===name && x.length==length && x.width==width && x.height==height);
      if(!p){
        p = { id: id || `${name}|${length}x${width}x${height}`, name, length, width, height, vendor:'', qty:0, safety:0, unit: unit||'개', lastIn: new Date().toISOString().slice(0,10) };
        list.push(p);
      }
      p.qty = (p.qty||0) + Number(qty||0);
      p.unit = p.unit || unit || '개';
      p.lastIn = new Date().toISOString().slice(0,10);
      saveProducts(list);
    };
  </script>
</body>
</html>