<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>작업자 편성 관리</title>
  <link rel="stylesheet" href="assets/nav.css">
  <style>
    :root{ --bd:#e5e7eb; --fg:#111; --mut:#6b7280; --bg:#f5f6f8; --card:#fff; --primary:#667eea; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;padding-top:60px}
    .container{max-width:1400px;margin:16px auto;padding:0 12px}
    h2{margin:0 0 12px;font-size:20px;font-weight:800}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:20px;margin-bottom:16px}
    
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:16px}
    .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:16px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .stat-card .label{font-size:12px;opacity:.9;margin-bottom:4px}
    .stat-card .value{font-size:28px;font-weight:800}
    
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .inp,.sel,.btn{border:1px solid var(--bd);border-radius:6px;font-size:13px}
    .inp,.sel{height:34px;padding:0 10px;background:#fff}
    .btn{height:34px;padding:0 14px;background:#fff;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.sm{height:28px;padding:0 10px;font-size:12px}
    
    .date-nav{display:flex;gap:8px;align-items:center;margin-bottom:16px}
    .date-nav .current-date{font-size:18px;font-weight:700;flex:1;text-align:center}
    
    .assignment-grid{display:grid;gap:12px}
    .assignment-card{background:#fff;border:1px solid var(--bd);border-radius:8px;padding:12px;position:relative}
    .assignment-card .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .assignment-card .process{font-size:16px;font-weight:700;color:#667eea}
    .assignment-card .machine{color:var(--mut);font-size:12px}
    .assignment-card .info{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;font-size:13px;margin-bottom:8px}
    .assignment-card .info .label{color:var(--mut);font-size:11px}
    .assignment-card .workers{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px}
    .worker-tag{display:inline-block;padding:3px 8px;background:#f3f4f6;border-radius:999px;font-size:11px}
    .actions{display:flex;gap:4px;margin-top:8px}
    
    .empty{color:var(--mut);text-align:center;padding:40px;font-size:14px}

    /* 수정 모달 */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px}
    .modal.show{display:flex}
    .modal-card{background:#fff;border-radius:12px;width:min(980px,95%);max-height:90vh;overflow:auto;padding:18px;box-shadow:0 10px 40px rgba(0,0,0,.25)}
    .modal-title{margin:0 0 12px;font-size:18px;font-weight:800;color:#667eea}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .tbl-wrap{border:1px solid var(--bd);border-radius:10px;overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:13px;background:#fff}
    th,td{padding:8px;border-bottom:1px solid #f1f3f5;text-align:center;white-space:nowrap}
    thead{background:#f8f9fa;position:sticky;top:0}
    .tag{display:inline-block;padding:4px 8px;border:1px solid #e5e7eb;border-radius:999px;font-size:12px;margin:2px;background:#fafafa}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header class="fixed-header"></header>

  <!-- 수정 모달 -->
  <div id="editModal" class="modal">
    <div class="modal-card">
      <h3 class="modal-title" id="editModalTitle">작업자 편성 수정</h3>
      <div class="grid">
        <div class="card">
          <div class="field">
            <label><strong>공정</strong></label>
            <input id="editProcess" class="inp" readonly style="background:#f9fafb;font-weight:700">
          </div>
          <div class="field">
            <label>호기 *</label>
            <select id="editMachine" class="sel"></select>
          </div>
          <div class="row">
            <div class="field" style="flex:1;min-width:180px">
              <label>작업일 *</label>
              <input id="editDate" type="date" class="inp">
            </div>
            <div class="field" style="flex:1;min-width:140px">
              <label>작업조 *</label>
              <div class="row">
                <label><input type="radio" name="editTeam" value="A"> A조</label>
                <label><input type="radio" name="editTeam" value="B"> B조</label>
              </div>
            </div>
            <div class="field" style="flex:1;min-width:140px">
              <label>근무 *</label>
              <div class="row">
                <label><input type="radio" name="editShift" value="주간"> 주간</label>
                <label><input type="radio" name="editShift" value="야간"> 야간</label>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="field" style="flex:1">
              <label>시작시간</label>
              <input id="editStart" type="time" class="inp">
            </div>
            <div class="field" style="flex:1">
              <label>종료시간</label>
              <input id="editEnd" type="time" class="inp">
            </div>
          </div>
          <div class="field">
            <label><strong>선택된 작업자</strong></label>
            <div id="editSelected" class="row" style="min-height:40px;border:1px dashed #ddd;border-radius:6px;padding:8px"></div>
          </div>
        </div>

        <div class="card">
          <div class="row" style="margin-bottom:8px">
            <input id="editEmpSearch" class="inp" placeholder="작업자 검색" style="flex:1">
            <select id="editEmpDept" class="sel" style="width:120px">
              <option value="">전체 부서</option>
              <option>생산부</option><option>품질관리부</option><option>영업부</option>
            </select>
          </div>
          <div class="tbl-wrap" style="max-height:380px">
            <table>
              <thead><tr><th style="width:36px">선택</th><th>사번</th><th>이름</th><th>부서</th><th>직급</th></tr></thead>
              <tbody id="editEmpTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="btnEditCancel">취소</button>
        <button class="btn primary" id="btnEditSave">저장</button>
      </div>
    </div>
  </div>

  <main class="container">
    <h2>작업자 편성 관리</h2>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="label">오늘 편성</div>
        <div class="value" id="statToday">0</div>
      </div>
      <div class="stat-card">
        <div class="label">이번 주</div>
        <div class="value" id="statWeek">0</div>
      </div>
      <div class="stat-card">
        <div class="label">투입 인원</div>
        <div class="value" id="statWorkers">0</div>
      </div>
    </div>

    <div class="date-nav">
      <button class="btn" id="btnPrevDate">◀ 이전</button>
      <div class="current-date" id="currentDate"></div>
      <button class="btn" id="btnNextDate">다음 ▶</button>
      <button class="btn primary" id="btnToday">오늘</button>
    </div>

    <div class="toolbar">
      <select id="filterProcess" class="sel" style="width:120px">
        <option value="">전체 공정</option>
        <option value="인쇄">인쇄</option>
        <option value="톰슨">톰슨</option>
        <option value="코팅">코팅</option>
        <option value="접착">접착</option>
        <option value="합지">합지</option>
      </select>
      <select id="filterTeam" class="sel" style="width:100px">
        <option value="">전체 조</option>
        <option value="A">A조</option>
        <option value="B">B조</option>
      </select>
      <select id="filterShift" class="sel" style="width:100px">
        <option value="">전체 근무</option>
        <option value="주간">주간</option>
        <option value="야간">야간</option>
      </select>
      <button class="btn" id="btnFilter">검색</button>
      <button class="btn" id="btnExport" style="margin-left:auto">CSV 내보내기</button>
    </div>

    <div class="card">
      <div class="assignment-grid" id="assignmentList"></div>
    </div>
  </main>

  <script src="assets/perm.js"></script>
  <script src="assets/nav.js"></script>
  <script>
    const empNo = sessionStorage.getItem('sepnp_emp_no');
    const empRole = sessionStorage.getItem('sepnp_emp_role');
    if(!empNo) location.href='index.html';

    const KEY_ASSIGNMENTS = 'sepnp_worker_assignments';
    const $ = s => document.querySelector(s);
    
    const PROCESS_MAP = {
      '인쇄': ['1호기','2호기','3호기'],
      '코팅': ['오버코팅 1호기','오버코팅 2호기','오버코팅 3호기','UV코팅기','라미네이팅기','하이델베르그금박기','YUYIN 1호기','YUYIN 2호기'],
      '접착': ['접착 1호기','접착 2호기','접착 3호기','접착 4호기','접착 5호기','접착 6호기','접착 7호기','PE접착기'],
      '톰슨': ['1호기','2호기','3호기','4호기','5호기'],
      '합지': ['합지기','합지톰슨기']
    };

    let currentDate = new Date();
    let editingIndex = null;
    let editingDateKey = null;
    const editSelectedEmpNos = new Set();
    
    async function loadAssignments(date) {
      try {
        let assignments = [];
        
        if (window.USE_MYSQL) {
          assignments = await API.getAssignments(date);
        } else {
          const allAssignments = JSON.parse(localStorage.getItem('sepnp_worker_assignments') || '{}');
          assignments = allAssignments[date] || [];
        }
        
        renderAssignmentTable(assignments);
      } catch (error) {
        console.error('편성 로드 오류:', error);
        alert('작업자 편성을 불러오는데 실패했습니다.');
      }
    }

    async function saveAssignment(assignmentData) {
      try {
        if (window.USE_MYSQL) {
          if (assignmentData.id && assignmentData.id !== 'new') {
            await API.updateAssignment(assignmentData.id, assignmentData);
          } else {
            await API.createAssignment(assignmentData);
          }
        } else {
          // localStorage 저장
          const allAssignments = JSON.parse(localStorage.getItem('sepnp_worker_assignments') || '{}');
          if (!allAssignments[assignmentData.date]) {
            allAssignments[assignmentData.date] = [];
          }
          
          const index = allAssignments[assignmentData.date].findIndex(a => a.id === assignmentData.id);
          if (index >= 0) {
            allAssignments[assignmentData.date][index] = assignmentData;
          } else {
            allAssignments[assignmentData.date].push(assignmentData);
          }
          
          localStorage.setItem('sepnp_worker_assignments', JSON.stringify(allAssignments));
        }
        
        alert('저장되었습니다.');
        loadAssignments(assignmentData.date);
      } catch (error) {
        console.error('편성 저장 오류:', error);
        alert('저장에 실패했습니다.');
      }
    }

    async function deleteAssignment(id, date) {
      if (!confirm('정말 삭제하시겠습니까?')) return;
      
      try {
        if (window.USE_MYSQL) {
          await API.deleteAssignment(id);
        } else {
          const allAssignments = JSON.parse(localStorage.getItem('sepnp_worker_assignments') || '{}');
          if (allAssignments[date]) {
            allAssignments[date] = allAssignments[date].filter(a => a.id !== id);
            localStorage.setItem('sepnp_worker_assignments', JSON.stringify(allAssignments));
          }
        }
        
        alert('삭제되었습니다.');
        loadAssignments(date);
      } catch (error) {
        console.error('편성 삭제 오류:', error);
        alert('삭제에 실패했습니다.');
      }
    }
    
    function formatDate(date){
      const weekdays = ['일','월','화','수','목','금','토'];
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth()+1).padStart(2,'0');
      const dd = String(date.getDate()).padStart(2,'0');
      const day = weekdays[date.getDay()];
      return `${yyyy}-${mm}-${dd} (${day})`;
    }
    
    function getDateKey(date){
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth()+1).padStart(2,'0');
      const dd = String(date.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    
    function updateStats(){
      const data = loadAssignments();
      const today = getDateKey(new Date());
      
      const todayAssigns = data[today] || [];
      $('#statToday').textContent = todayAssigns.length;
      
      const weekStart = new Date();
      weekStart.setDate(weekStart.getDate() - weekStart.getDay());
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);
      
      let weekCount = 0;
      Object.keys(data).forEach(dateKey => {
        const d = new Date(dateKey);
        if(d >= weekStart && d <= weekEnd){
          weekCount += data[dateKey].length;
        }
      });
      $('#statWeek').textContent = weekCount;
      
      const allWorkers = new Set();
      todayAssigns.forEach(a => {
        (a.workers||[]).forEach(w => allWorkers.add(w));
      });
      $('#statWorkers').textContent = allWorkers.size;
    }
    
    function getActiveEmployees(){
      try{
        const emps = JSON.parse(localStorage.getItem('sepnp_employees')||'[]');
        return emps.filter(e=> (e.status||'active')==='active');
      }catch(e){ return []; }
    }

    function renderAssignments(){
      const dateKey = getDateKey(currentDate);
      const data = loadAssignments();
      const list = data[dateKey] || [];
      
      const filterProcess = $('#filterProcess').value;
      const filterTeam = $('#filterTeam').value;
      const filterShift = $('#filterShift').value;
      
      const filtered = list.filter(a => {
        const okP = !filterProcess || a.process === filterProcess;
        const okT = !filterTeam || a.team === filterTeam;
        const okS = !filterShift || a.shift === filterShift;
        return okP && okT && okS;
      });
      
      const container = $('#assignmentList');
      $('#currentDate').textContent = formatDate(currentDate);
      
      if(filtered.length === 0){
        container.innerHTML = '<div class="empty">이 날짜에 등록된 편성이 없습니다.</div>';
        return;
      }
      
      container.innerHTML = filtered.map((a, idx) => {
        const workerNames = (a.workers||[]).map(empNo => {
          const emps = getActiveEmployees();
          const emp = emps.find(e => e.empNo === empNo);
          return emp ? emp.name : empNo;
        });
        
        const originalIdx = list.indexOf(a);
        
        return `
          <div class="assignment-card">
            <div class="header">
              <div>
                <div class="process">${a.process} ${a.machine}</div>
                <div class="machine">${a.team}조 · ${a.shift}</div>
              </div>
              <div class="actions">
                <button class="btn sm" onclick="openEditModal('${dateKey}', ${originalIdx})">수정</button>
                <button class="btn sm" onclick="deleteAssignment('${dateKey}', ${originalIdx})">삭제</button>
              </div>
            </div>
            <div class="info">
              <div>
                <div class="label">시작</div>
                <div>${a.start || '-'}</div>
              </div>
              <div>
                <div class="label">종료</div>
                <div>${a.end || '-'}</div>
              </div>
            </div>
            <div class="workers">
              ${workerNames.map(n => `<span class="worker-tag">${n}</span>`).join('')}
            </div>
          </div>
        `;
      }).join('');
      
      updateStats();
    }

    function openEditModal(dateKey, index){
      const data = loadAssignments();
      const item = data[dateKey][index];
      if(!item) return;

      editingDateKey = dateKey;
      editingIndex = index;
      
      $('#editModalTitle').textContent = `${item.process} 작업자 편성 수정`;
      $('#editProcess').value = item.process;
      
      const machSel = $('#editMachine');
      machSel.innerHTML = (PROCESS_MAP[item.process]||[]).map(v=>`<option>${v}</option>`).join('');
      machSel.value = item.machine;
      
      $('#editDate').value = item.date;
      document.querySelector(`input[name="editTeam"][value="${item.team}"]`).checked = true;
      document.querySelector(`input[name="editShift"][value="${item.shift}"]`).checked = true;
      $('#editStart').value = item.start || '';
      $('#editEnd').value = item.end || '';
      
      editSelectedEmpNos.clear();
      (item.workers||[]).forEach(w => editSelectedEmpNos.add(w));
      renderEditSelectedTags();
      renderEditEmployeePicker();
      
      $('#editModal').classList.add('show');
    }

    function closeEditModal(){
      editingDateKey = null;
      editingIndex = null;
      $('#editModal').classList.remove('show');
    }

    function renderEditSelectedTags(){
      const box = $('#editSelected');
      const emps = getActiveEmployees().filter(e=>editSelectedEmpNos.has(e.empNo));
      box.innerHTML = emps.map(e=>`<span class="tag">${e.name} <small style="color:#6b7280">(${e.empNo})</small></span>`).join('')
        || '<span style="color:#9ca3af;font-size:12px">작업자를 선택하세요</span>';
    }

    function renderEditEmployeePicker(){
      const q = ($('#editEmpSearch').value||'').trim().toLowerCase();
      const dept = $('#editEmpDept').value||'';
      const tb = $('#editEmpTbody');
      const list = getActiveEmployees().filter(e=>{
        const okQ = !q || (e.name||'').toLowerCase().includes(q) || (e.empNo||'').toLowerCase().includes(q) || (e.dept||'').toLowerCase().includes(q);
        const okD = !dept || e.dept===dept;
        return okQ && okD;
      });
      tb.innerHTML = list.map(e=>`
        <tr>
          <td><input type="checkbox" data-empno="${e.empNo}" ${editSelectedEmpNos.has(e.empNo)?'checked':''}></td>
          <td>${e.empNo}</td>
          <td>${e.name}</td>
          <td>${e.dept||'-'}</td>
          <td>${e.position||'-'}</td>
        </tr>
      `).join('');

      tb.querySelectorAll("input[type='checkbox']").forEach(chk=>{
        chk.addEventListener('change', ()=>{
          const no = chk.dataset.empno;
          if(chk.checked) editSelectedEmpNos.add(no); else editSelectedEmpNos.delete(no);
          renderEditSelectedTags();
        });
      });
    }

    function saveEdit(){
      if(editingDateKey === null || editingIndex === null) return;
      
      const data = loadAssignments();
      const item = data[editingDateKey][editingIndex];
      
      item.machine = $('#editMachine').value;
      item.date = $('#editDate').value;
      item.team = document.querySelector('input[name="editTeam"]:checked')?.value||'A';
      item.shift = document.querySelector('input[name="editShift"]:checked')?.value||'주간';
      item.start = $('#editStart').value;
      item.end = $('#editEnd').value;
      item.workers = Array.from(editSelectedEmpNos);
      item.updatedAt = new Date().toISOString();
      
      saveAssignments(data);
      alert('수정되었습니다.');
      closeEditModal();
      renderAssignments();
    }
    
    function deleteAssignment(dateKey, index){
      if(!confirm('이 편성을 삭제하시겠습니까?')) return;
      
      const data = loadAssignments();
      if(data[dateKey]){
        data[dateKey].splice(index, 1);
        if(data[dateKey].length === 0) delete data[dateKey];
        saveAssignments(data);
        renderAssignments();
      }
    }
    
    function exportCSV(){
      const data = loadAssignments();
      const header = ['날짜','공정','호기','작업조','근무','시작시간','종료시간','작업자'];
      const rows = [];
      
      Object.keys(data).sort().forEach(dateKey => {
        data[dateKey].forEach(a => {
          const emps = getActiveEmployees();
          const workerNames = (a.workers||[]).map(empNo => {
            const emp = emps.find(e => e.empNo === empNo);
            return emp ? emp.name : empNo;
          }).join(', ');
          
          rows.push([
            dateKey,
            a.process,
            a.machine,
            a.team,
            a.shift,
            a.start || '',
            a.end || '',
            workerNames
          ]);
        });
      });
      
      const csv = [header].concat(rows).map(r => r.map(v => `"${v}"`).join(',')).join('\r\n');
      const blob = new Blob(['\ufeff'+csv], {type:'text/csv;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `작업자편성_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    }
    
    $('#btnPrevDate').addEventListener('click', ()=>{
      currentDate.setDate(currentDate.getDate() - 1);
      renderAssignments();
    });
    
    $('#btnNextDate').addEventListener('click', ()=>{
      currentDate.setDate(currentDate.getDate() + 1);
      renderAssignments();
    });
    
    $('#btnToday').addEventListener('click', ()=>{
      currentDate = new Date();
      renderAssignments();
    });
    
    $('#btnFilter').addEventListener('click', renderAssignments);
    $('#btnExport').addEventListener('click', exportCSV);
    $('#btnEditCancel').addEventListener('click', closeEditModal);
    $('#btnEditSave').addEventListener('click', saveEdit);
    $('#editEmpSearch').addEventListener('input', renderEditEmployeePicker);
    $('#editEmpDept').addEventListener('change', renderEditEmployeePicker);
    $('#editModal').addEventListener('click', (e)=>{ if(e.target.id==='editModal') closeEditModal(); });
    
    document.addEventListener('DOMContentLoaded', ()=>{
      Permissions.applyGates();
      renderAssignments();
    });
  </script>
</body>
</html>