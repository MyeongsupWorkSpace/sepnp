<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SEPNP í¬í„¸ - í™ˆ</title>
  <link rel="stylesheet" href="assets/nav.css">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif;
      background: #f5f6f8;
      color: #111;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 24px;
    }
    
    .welcome {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 48px 32px;
      border-radius: 16px;
      margin-bottom: 32px;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
    }
    
    .welcome h1 {
      margin: 0 0 12px;
      font-size: 32px;
      font-weight: 700;
    }
    
    .welcome p {
      margin: 0;
      font-size: 16px;
      opacity: 0.95;
    }
    
    .section-title {
      font-size: 20px;
      font-weight: 700;
      margin: 0 0 20px;
      color: #333;
    }
    
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }
    
    .menu-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      text-decoration: none;
      color: inherit;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      overflow: hidden;
    }
    
    .menu-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      transform: scaleY(0);
      transition: transform 0.2s ease;
    }
    
    .menu-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      border-color: #667eea;
    }
    
    .menu-card:hover::before {
      transform: scaleY(1);
    }
    
    .menu-card-icon {
      font-size: 32px;
      line-height: 1;
    }
    
    .menu-card-title {
      font-size: 18px;
      font-weight: 600;
      color: #111;
      margin: 0;
    }
    
    .menu-card-desc {
      font-size: 14px;
      color: #666;
      margin: 0;
      line-height: 1.5;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }
    
    .stat-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .stat-label {
      font-size: 13px;
      color: #666;
      font-weight: 500;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #111;
    }
    
    .stat-card.primary .stat-value {
      color: #667eea;
    }
    
    .stat-card.success .stat-value {
      color: #10b981;
    }
    
    .stat-card.warning .stat-value {
      color: #f59e0b;
    }
    
    /* ì‘ì—…ì í¸ì„± ëª¨ë‹¬ */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px}
    .modal.show{display:flex}
    .modal-card{background:#fff;border-radius:12px;width:min(980px,95%);max-height:90vh;overflow:auto;padding:18px 18px 12px;box-shadow:0 10px 40px rgba(0,0,0,.25)}
    .modal-title{margin:0 0 12px;font-size:18px;font-weight:800;color:#667eea}
    .grid{display:grid;grid-template-columns: 1.2fr 1fr; gap:16px}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .inp,.sel{height:36px;border:1px solid #e5e7eb;border-radius:8px;padding:0 10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .card{border:1px solid #e5e7eb;border-radius:10px;padding:12px;background:#fafbfc}
    .tbl-wrap{border:1px solid #e5e7eb;border-radius:10px;overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:13px;background:#fff}
    th,td{padding:8px;border-bottom:1px solid #f1f3f5;text-align:center;white-space:nowrap}
    thead{background:#f8f9fa;position:sticky;top:0}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .btn{height:34px;padding:0 12px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer;font-weight:700;font-size:13px}
    .btn.primary{background:#667eea;border-color:#667eea;color:#fff}
    .btn.danger{background:#ef4444;border-color:#ef4444;color:#fff}
    .tag{display:inline-block;padding:4px 8px;border:1px solid #e5e7eb;border-radius:999px;font-size:12px;margin:2px;background:#fafafa}
    @media(max-width:900px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header class="fixed-header"></header>

  <!-- ì‘ì—…ì í¸ì„± ëª¨ë‹¬ -->
  <div id="assignModal" class="modal">
    <div class="modal-card">
      <h3 class="modal-title" id="assignModalTitle">ì‘ì—…ì í¸ì„±</h3>
      <div class="grid">
        <!-- ì¢Œì¸¡: ê¸°ë³¸ ì •ë³´ -->
        <div class="card">
          <div class="field">
            <label><strong>ê³µì •</strong></label>
            <input id="asProcess" class="inp" readonly style="background:#f9fafb;font-weight:700">
          </div>
          <div class="field">
            <label>í˜¸ê¸° *</label>
            <select id="asMachine" class="sel" required></select>
          </div>
          <div class="row">
            <div class="field" style="flex:1;min-width:180px">
              <label>ì‘ì—…ì¼ *</label>
              <input id="asDate" type="date" class="inp" required>
            </div>
            <div class="field" style="flex:1;min-width:140px">
              <label>ì‘ì—…ì¡° *</label>
              <div class="row">
                <label><input type="radio" name="asTeam" value="A" checked> Aì¡°</label>
                <label><input type="radio" name="asTeam" value="B"> Bì¡°</label>
              </div>
            </div>
            <div class="field" style="flex:1;min-width:140px">
              <label>ê·¼ë¬´ *</label>
              <div class="row">
                <label><input type="radio" name="asShift" value="ì£¼ê°„" checked> ì£¼ê°„</label>
                <label><input type="radio" name="asShift" value="ì•¼ê°„"> ì•¼ê°„</label>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="field" style="flex:1;min-width:150px">
              <label>ì‹œì‘ì‹œê°„</label>
              <input id="asStart" type="time" class="inp">
            </div>
            <div class="field" style="flex:1;min-width:150px">
              <label>ì¢…ë£Œì‹œê°„</label>
              <input id="asEnd" type="time" class="inp">
            </div>
            <div class="field" style="min-width:150px">
              <label>&nbsp;</label>
              <button id="btnClearTime" class="btn">ì‹œê°„ì‚­ì œ</button>
            </div>
          </div>
          <div class="field">
            <label><strong>ì„ íƒëœ ì‘ì—…ì</strong></label>
            <div id="asSelected" class="row" style="min-height:40px;border:1px dashed #ddd;border-radius:6px;padding:8px"></div>
          </div>
        </div>

        <!-- ìš°ì¸¡: ì‘ì—…ì ì„ íƒ -->
        <div class="card">
          <div class="row" style="margin-bottom:8px">
            <input id="empSearch" class="inp" placeholder="ì‘ì—…ì ê²€ìƒ‰(ì´ë¦„/ë¶€ì„œ/ì‚¬ë²ˆ)" style="flex:1;min-width:180px">
            <select id="empDeptFilter" class="sel" style="width:140px;min-width:120px">
              <option value="">ì „ì²´ ë¶€ì„œ</option>
              <option>ìƒì‚°ë¶€</option><option>í’ˆì§ˆê´€ë¦¬ë¶€</option><option>ì˜ì—…ë¶€</option>
              <option>ê´€ë¦¬ë¶€</option><option>ì—°êµ¬ê°œë°œë¶€</option><option>ë¬¼ë¥˜ë¶€</option>
            </select>
          </div>
          <div class="tbl-wrap" style="max-height:380px">
            <table>
              <thead><tr><th style="width:36px">ì„ íƒ</th><th>ì‚¬ë²ˆ</th><th>ì´ë¦„</th><th>ë¶€ì„œ</th><th>ì§ê¸‰</th></tr></thead>
              <tbody id="empPickTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="btnAssignCancel">ì·¨ì†Œ</button>
        <button class="btn primary" id="btnAssignSave">í™•ì¸</button>
      </div>
    </div>
  </div>

  <main class="container">
    <section class="welcome">
      <h1 id="welcomeMsg">í™˜ì˜í•©ë‹ˆë‹¤</h1>
      <p>SEPNP ìƒì‚°ê´€ë¦¬ ì‹œìŠ¤í…œì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</p>
    </section>

    <section class="stats-section">
      <h2 class="section-title">ğŸ“Š ì˜¤ëŠ˜ì˜ í˜„í™©</h2>
      <div class="stats-grid">
        <div class="stat-card primary">
          <div class="stat-label">ì§„í–‰ ì¤‘ì¸ ì‘ì—…</div>
          <div class="stat-value" id="statProgress">-</div>
        </div>
        <div class="stat-card success">
          <div class="stat-label">ì™„ë£Œëœ ì‘ì—…</div>
          <div class="stat-value" id="statCompleted">-</div>
        </div>
        <div class="stat-card warning">
          <div class="stat-label">ëŒ€ê¸° ì¤‘ì¸ ì£¼ë¬¸</div>
          <div class="stat-value" id="statWaiting">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ë“±ë¡ëœ ì œí’ˆ</div>
          <div class="stat-value" id="statProducts">-</div>
        </div>
      </div>
    </section>

    <section class="menu-section">
      <h2 class="section-title">ğŸ¯ ì£¼ìš” ê¸°ëŠ¥</h2>
      <div class="card-grid">
        <a href="print-plan.html" class="menu-card" data-perm="plan.view" data-perm-mode="hide">
          <div class="menu-card-icon">ğŸ“‹</div>
          <h3 class="menu-card-title">ì¸ì‡„ê³„íší‘œ</h3>
          <p class="menu-card-desc">ì¼ì¼ ì¸ì‡„ ì‘ì—… ê³„íšì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤</p>
        </a>

        <a href="assign.html" class="menu-card" data-perm="assign.view" data-perm-mode="hide">
          <div class="menu-card-icon">ğŸ–¨ï¸</div>
          <h3 class="menu-card-title">ì¸ì‡„ë°°ì •</h3>
          <p class="menu-card-desc">ì‘ì—…ì„ í˜¸ê¸°ë³„ë¡œ ë°°ì •í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤</p>
        </a>

        <a href="work-status.html" class="menu-card" data-perm="work.view" data-perm-mode="hide">
          <div class="menu-card-icon">ğŸ“Š</div>
          <h3 class="menu-card-title">ì‘ì—…í˜„í™©</h3>
          <p class="menu-card-desc">ì‹¤ì‹œê°„ ì‘ì—… ìƒíƒœë¥¼ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤</p>
        </a>

        <a href="product-register.html" class="menu-card" data-perm="product.view" data-perm-mode="hide">
          <div class="menu-card-icon">â•</div>
          <h3 class="menu-card-title">ì œí’ˆ ë“±ë¡</h3>
          <p class="menu-card-desc">ìƒˆë¡œìš´ ì œí’ˆ ì •ë³´ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤</p>
        </a>

        <a href="order-register.html" class="menu-card" data-perm="order.view" data-perm-mode="hide">
          <div class="menu-card-icon">ğŸ“</div>
          <h3 class="menu-card-title">ìˆ˜ì£¼ ì˜¤ë” ë“±ë¡</h3>
          <p class="menu-card-desc">ì‹ ê·œ ì£¼ë¬¸ì„ ì ‘ìˆ˜í•˜ê³  ë“±ë¡í•©ë‹ˆë‹¤</p>
        </a>

        <a href="product-list.html" class="menu-card" data-perm="product.view" data-perm-mode="hide">
          <div class="menu-card-icon">ğŸ“š</div>
          <h3 class="menu-card-title">ì œí’ˆ ëª©ë¡</h3>
          <p class="menu-card-desc">ë“±ë¡ëœ ì œí’ˆì„ ì¡°íšŒí•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤</p>
        </a>

        <a href="inventory.html" class="menu-card" data-perm="inventory.view" data-perm-mode="hide">
          <div class="menu-card-icon">ğŸ“¦</div>
          <h3 class="menu-card-title">ì¬ê³ í˜„í™©</h3>
          <p class="menu-card-desc">ì¬ê³  ìˆ˜ëŸ‰ì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤</p>
        </a>

        <a href="dispatch.html" class="menu-card" data-perm="dispatch.view" data-perm-mode="hide">
          <div class="menu-card-icon">ğŸšš</div>
          <h3 class="menu-card-title">ë°°ì°¨ê´€ë¦¬</h3>
          <p class="menu-card-desc">ë°°ì†¡ ì°¨ëŸ‰ì„ ë°°ì •í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤</p>
        </a>

        <a href="sales.html" class="menu-card" data-perm="sales.view" data-perm-mode="hide">
          <div class="menu-card-icon">ğŸ’°</div>
          <h3 class="menu-card-title">ë§¤ì¶œí˜„í™©</h3>
          <p class="menu-card-desc">ë§¤ì¶œ í†µê³„ì™€ ë¶„ì„ ì •ë³´ë¥¼ í™•ì¸í•©ë‹ˆë‹¤</p>
        </a>

        <a href="quotation.html" class="menu-card" data-perm="quotation.view" data-perm-mode="hide">
          <div class="menu-card-icon">ğŸ“„</div>
          <h3 class="menu-card-title">ê²¬ì ì„œ</h3>
          <p class="menu-card-desc">ê²¬ì ì„œë¥¼ ì‘ì„±í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤</p>
        </a>

        <a href="employee-management.html" class="menu-card" data-perm="employee.view" data-perm-mode="hide">
          <div class="menu-card-icon">ğŸ‘¥</div>
          <h3 class="menu-card-title">ì‚¬ì›ê´€ë¦¬</h3>
          <p class="menu-card-desc">ì‚¬ì› ì •ë³´ë¥¼ ë“±ë¡í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤</p>
        </a>

        <a href="worker-assignment.html" class="menu-card" data-perm="assign.print" data-perm-mode="hide">
          <div class="menu-card-icon">ğŸ‘·</div>
          <h3 class="menu-card-title">ì‘ì—…ì í¸ì„± ê´€ë¦¬</h3>
          <p class="menu-card-desc">ë“±ë¡ëœ ì‘ì—…ì í¸ì„±ì„ ì¡°íšŒí•˜ê³  ìˆ˜ì •í•©ë‹ˆë‹¤</p>
        </a>
      </div>
    </section>
  </main>

  <script src="assets/perm.js"></script>
  <script src="assets/nav.js"></script>
  <script>
    // ì„¸ì…˜ í™•ì¸
    const empNo = sessionStorage.getItem('sepnp_emp_no');
    const empName = sessionStorage.getItem('sepnp_emp_name');
    const empRole = sessionStorage.getItem('sepnp_emp_role');

    if (!empNo) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      location.href = 'index.html';
    }

    // ê¶Œí•œ ë¡œë“œ
    let userPerms = [];
    try {
      const permsJson = sessionStorage.getItem('sepnp_emp_perms');
      if (permsJson) {
        userPerms = JSON.parse(permsJson);
      }
    } catch (e) {
      console.error('ê¶Œí•œ íŒŒì‹± ì˜¤ë¥˜:', e);
    }

    console.log('âœ… ë¡œê·¸ì¸ ì‚¬ìš©ì:', empName, '/', empRole);
    console.log('âœ… ê¶Œí•œ:', userPerms);

    function loadStats() {
      try {
        // ì‘ì—… í˜„í™©
        const workStatus = JSON.parse(localStorage.getItem('sepnp_workstatus_v3') || '{"pool":[],"lanes":{},"completed":[]}');
        
        // ì§„í–‰ ì¤‘ ì‘ì—…
        let progressCount = 0;
        if (workStatus.lanes) {
          Object.values(workStatus.lanes).forEach(lane => {
            progressCount += Array.isArray(lane) ? lane.filter(c => c.status === 'prog').length : 0;
          });
        }
        document.getElementById('statProgress').textContent = progressCount;

        // ì™„ë£Œëœ ì‘ì—… (ì˜¤ëŠ˜)
        const today = new Date().toISOString().slice(0, 10);
        const completedToday = Array.isArray(workStatus.completed) 
          ? workStatus.completed.filter(c => c.completedAt && c.completedAt.startsWith(today)).length 
          : 0;
        document.getElementById('statCompleted').textContent = completedToday;

        // ëŒ€ê¸° ì¤‘ ì£¼ë¬¸
        const waitingCount = Array.isArray(workStatus.pool) ? workStatus.pool.length : 0;
        document.getElementById('statWaiting').textContent = waitingCount;

        // ë“±ë¡ëœ ì œí’ˆ
        const products = JSON.parse(localStorage.getItem('sepnp_products') || '[]');
        document.getElementById('statProducts').textContent = products.length;

      } catch (e) {
        console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', e);
        document.getElementById('statProgress').textContent = '0';
        document.getElementById('statCompleted').textContent = '0';
        document.getElementById('statWaiting').textContent = '0';
        document.getElementById('statProducts').textContent = '0';
      }
    }
    
    // ===== ì‘ì—…ì í¸ì„± ë¡œì§ =====
    const KEY_ASSIGNMENTS = 'sepnp_worker_assignments';

    const PROCESS_MAP = {
      'assign.print': { 
        name: 'ì¸ì‡„', 
        machines: ['1í˜¸ê¸°','2í˜¸ê¸°','3í˜¸ê¸°'] 
      },
      'assign.coating': { 
        name: 'ì½”íŒ…', 
        machines: ['ì˜¤ë²„ì½”íŒ… 1í˜¸ê¸°','ì˜¤ë²„ì½”íŒ… 2í˜¸ê¸°','ì˜¤ë²„ì½”íŒ… 3í˜¸ê¸°','UVì½”íŒ…ê¸°','ë¼ë¯¸ë„¤ì´íŒ…ê¸°','í•˜ì´ë¸ë² ë¥´ê·¸ê¸ˆë°•ê¸°','YUYIN 1í˜¸ê¸°','YUYIN 2í˜¸ê¸°'] 
      },
      'assign.adhesive': { 
        name: 'ì ‘ì°©', 
        machines: ['ì ‘ì°© 1í˜¸ê¸°','ì ‘ì°© 2í˜¸ê¸°','ì ‘ì°© 3í˜¸ê¸°','ì ‘ì°© 4í˜¸ê¸°','ì ‘ì°© 5í˜¸ê¸°','ì ‘ì°© 6í˜¸ê¸°','ì ‘ì°© 7í˜¸ê¸°','PEì ‘ì°©ê¸°'] 
      },
      'assign.thomson': { 
        name: 'í†°ìŠ¨', 
        machines: ['1í˜¸ê¸°','2í˜¸ê¸°','3í˜¸ê¸°','4í˜¸ê¸°','5í˜¸ê¸°'] 
      },
      'assign.lamination': { 
        name: 'í•©ì§€', 
        machines: ['í•©ì§€ê¸°','í•©ì§€í†°ìŠ¨ê¸°'] 
      }
    };

    function getMyAssignPerms(){
      const perms = [];
      
      // ê´€ë¦¬ìëŠ” ëª¨ë“  ê¶Œí•œ ìë™ ë¶€ì—¬
      if(empRole === 'admin') {
        console.log('[getMyAssignPerms] ê´€ë¦¬ì â†’ ëª¨ë“  ë°°ì • ê¶Œí•œ ë¶€ì—¬');
        return Object.keys(PROCESS_MAP);
      }
      
      // Permissions ëª¨ë“ˆì´ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
      if(!window.Permissions){
        console.warn('[getMyAssignPerms] Permissions ëª¨ë“ˆ ì—†ìŒ');
        return perms;
      }
      
      for(let p in PROCESS_MAP){
        if(Permissions.has(p)) {
          perms.push(p);
        }
      }
      
      console.log('[getMyAssignPerms] ê°ì§€ëœ ê¶Œí•œ:', perms);
      return perms;
    }

    function loadAssignments(){
      try{ return JSON.parse(localStorage.getItem(KEY_ASSIGNMENTS) || '{}'); }
      catch(e){ return {}; }
    }
    function saveAssignments(data){
      localStorage.setItem(KEY_ASSIGNMENTS, JSON.stringify(data));
    }

    let currentProcessPerm = null;
    const selectedEmpNos = new Set();

    function openAssignModal(processPerm){
      console.log('[openAssignModal] í˜¸ì¶œë¨, ê¶Œí•œ:', processPerm);
      if(!processPerm || !PROCESS_MAP[processPerm]) {
        console.error('[openAssignModal] ìœ íš¨í•˜ì§€ ì•Šì€ ê¶Œí•œ:', processPerm);
        return;
      }
      currentProcessPerm = processPerm;
      const pdata = PROCESS_MAP[processPerm];

      document.getElementById('assignModalTitle').textContent = `${pdata.name} ì‘ì—…ì í¸ì„±`;
      document.getElementById('asProcess').value = pdata.name;

      // í˜¸ê¸° ëª©ë¡
      const mach = document.getElementById('asMachine');
      mach.innerHTML = pdata.machines.map(v=>`<option>${v}</option>`).join('');

      // ê¸°ë³¸ê°’
      const today = new Date().toISOString().slice(0,10);
      document.getElementById('asDate').value = today;
      document.querySelector("input[name='asTeam'][value='A']").checked = true;
      document.querySelector("input[name='asShift'][value='ì£¼ê°„']").checked = true;
      
      // ì£¼ê°„ ê¸°ë³¸ ì‹œê°„ ì„¤ì •
      document.getElementById('asStart').value = '08:30';
      document.getElementById('asEnd').value = '17:30';

      selectedEmpNos.clear();
      renderSelectedTags();
      renderEmployeePicker();

      document.getElementById('assignModal').classList.add('show');
      console.log('[openAssignModal] ëª¨ë‹¬ í‘œì‹œë¨');
    }

    function closeAssignModal(){
      currentProcessPerm = null;
      document.getElementById('assignModal').classList.remove('show');
    }

    function getActiveEmployees(){
      try{
        const emps = JSON.parse(localStorage.getItem('sepnp_employees')||'[]');
        return emps.filter(e=> (e.status||'active')==='active');
      }catch(e){ return []; }
    }

    function renderSelectedTags(){
      const box = document.getElementById('asSelected');
      const emps = getActiveEmployees().filter(e=>selectedEmpNos.has(e.empNo));
      box.innerHTML = emps.map(e=>`<span class="tag">${e.name} <small style="color:#6b7280">(${e.empNo})</small></span>`).join('')
        || '<span style="color:#9ca3af;font-size:12px">ì‘ì—…ìë¥¼ ì„ íƒí•˜ì„¸ìš”</span>';
    }

    function renderEmployeePicker(){
      const q = (document.getElementById('empSearch').value||'').trim().toLowerCase();
      const dept = document.getElementById('empDeptFilter').value||'';
      const tb = document.getElementById('empPickTbody');
      const list = getActiveEmployees().filter(e=>{
        const okQ = !q || (e.name||'').toLowerCase().includes(q) || (e.empNo||'').toLowerCase().includes(q) || (e.dept||'').toLowerCase().includes(q);
        const okD = !dept || e.dept===dept;
        return okQ && okD;
      });
      tb.innerHTML = list.map(e=>`
        <tr>
          <td><input type="checkbox" data-empno="${e.empNo}" ${selectedEmpNos.has(e.empNo)?'checked':''}></td>
          <td>${e.empNo}</td>
          <td>${e.name}</td>
          <td>${e.dept||'-'}</td>
          <td>${e.position||'-'}</td>
        </tr>
      `).join('');

      tb.querySelectorAll("input[type='checkbox']").forEach(chk=>{
        chk.addEventListener('change', ()=>{
          const no = chk.dataset.empno;
          if(chk.checked) selectedEmpNos.add(no); else selectedEmpNos.delete(no);
          renderSelectedTags();
        });
      });
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    document.getElementById('btnClearTime')?.addEventListener('click', ()=>{
      document.getElementById('asStart').value = '';
      document.getElementById('asEnd').value = '';
    });
    
    // ê·¼ë¬´ í˜•íƒœ ë³€ê²½ ì‹œ ì‹œê°„ ìë™ ì„¤ì •
    document.querySelectorAll("input[name='asShift']").forEach(radio => {
      radio.addEventListener('change', (e) => {
        const shift = e.target.value;
        if(shift === 'ì£¼ê°„'){
          document.getElementById('asStart').value = '08:30';
          document.getElementById('asEnd').value = '17:30';
        } else if(shift === 'ì•¼ê°„'){
          document.getElementById('asStart').value = '18:30';
          document.getElementById('asEnd').value = '';
        }
      });
    });
    
    document.getElementById('btnAssignCancel')?.addEventListener('click', closeAssignModal);
    document.getElementById('btnAssignSave')?.addEventListener('click', ()=>{
      if(!currentProcessPerm) return;
      const pdata = PROCESS_MAP[currentProcessPerm];
      const date = document.getElementById('asDate').value;
      const machine = document.getElementById('asMachine').value;
      const team = document.querySelector("input[name='asTeam']:checked")?.value||'A';
      const shift = document.querySelector("input[name='asShift']:checked")?.value||'ì£¼ê°„';
      const start = document.getElementById('asStart').value;
      const end = document.getElementById('asEnd').value;

      if(!date){ alert('ì‘ì—…ì¼ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
      if(!machine){ alert('í˜¸ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
      if(selectedEmpNos.size===0){ alert('ì‘ì—…ìë¥¼ 1ëª… ì´ìƒ ì„ íƒí•˜ì„¸ìš”.'); return; }

      const data = loadAssignments();
      data[date] = data[date] || [];
      data[date].push({
        process: pdata.name,
        processPerm: currentProcessPerm,
        machine, date, team, shift, start, end,
        workers: Array.from(selectedEmpNos),
        createdBy: empNo, createdByName: empName,
        createdAt: new Date().toISOString()
      });
      saveAssignments(data);
      alert(`${pdata.name} ì‘ì—…ì í¸ì„±ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      closeAssignModal();
    });

    document.getElementById('empSearch')?.addEventListener('input', renderEmployeePicker);
    document.getElementById('empDeptFilter')?.addEventListener('change', renderEmployeePicker);
    document.getElementById('assignModal')?.addEventListener('click', (e)=>{ if(e.target.id==='assignModal') closeAssignModal(); });

    // ì²« ë¡œê·¸ì¸ ì‹œ í•˜ë£¨ 1íšŒ ìë™ í‘œì‹œ
    function tryShowAssignModal(){
      console.log('[tryShowAssignModal] ì‹¤í–‰');
      const today = new Date().toISOString().slice(0,10);
      const myPerms = getMyAssignPerms();
      
      console.log('[tryShowAssignModal] empNo:', empNo);
      console.log('[tryShowAssignModal] empRole:', empRole);
      console.log('[tryShowAssignModal] ë‚´ ë°°ì • ê¶Œí•œ:', myPerms);
      
      if (!empNo) {
        console.log('[tryShowAssignModal] ë¡œê·¸ì¸ ì•ˆ ë¨');
        return;
      }
      
      if (myPerms.length === 0) {
        console.log('[tryShowAssignModal] ë°°ì • ê¶Œí•œ ì—†ìŒ');
        return;
      }
      
      const sentinelKey = `sepnp_assign_prompt_${empNo}_${today}`;
      const alreadyShown = localStorage.getItem(sentinelKey);
      
      console.log('[tryShowAssignModal] ì„¼í‹°ë„ í‚¤:', sentinelKey);
      console.log('[tryShowAssignModal] ì˜¤ëŠ˜ ì´ë¯¸ í‘œì‹œë¨:', alreadyShown);
      
      if (alreadyShown) {
        console.log('[tryShowAssignModal] ì˜¤ëŠ˜ ì´ë¯¸ ëª¨ë‹¬ í‘œì‹œë¨ - ì¤‘ë‹¨');
        return;
      }
      
      // ê¶Œí•œ ìˆœì„œ: ì¸ì‡„ > í†°ìŠ¨ > ì½”íŒ… > ì ‘ì°© > í•©ì§€
      const order = ['assign.print','assign.thomson','assign.coating','assign.adhesive','assign.lamination'];
      const firstPerm = order.find(p => myPerms.includes(p));
      
      console.log('[tryShowAssignModal] ì„ íƒëœ ê¶Œí•œ:', firstPerm);
      
      if(firstPerm){
        console.log('[tryShowAssignModal] âœ… ëª¨ë‹¬ ì˜¤í”ˆ ì‹œì‘:', PROCESS_MAP[firstPerm].name);
        openAssignModal(firstPerm);
        localStorage.setItem(sentinelKey, '1');
      } else {
        console.log('[tryShowAssignModal] âŒ ìœ íš¨í•œ ê¶Œí•œ ì—†ìŒ');
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      console.log('='.repeat(50));
      console.log('[DOMContentLoaded] í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
      console.log('[DOMContentLoaded] empNo:', empNo);
      console.log('[DOMContentLoaded] empRole:', empRole);
      console.log('[DOMContentLoaded] Permissions ëª¨ë“ˆ:', window.Permissions ? 'ìˆìŒ' : 'ì—†ìŒ');
      console.log('='.repeat(50));
      
      Permissions.applyGates();
      loadStats();

      // ì—¬ëŸ¬ ì‹œì ì—ì„œ ëª¨ë‹¬ í‘œì‹œ ì‹œë„
      tryShowAssignModal(); // ì¦‰ì‹œ ì‹¤í–‰
      
      setTimeout(() => {
        console.log('[Timeout 500ms] ì¬ì‹œë„');
        tryShowAssignModal();
      }, 500);
      
      setTimeout(() => {
        console.log('[Timeout 1000ms] ìµœì¢… ì¬ì‹œë„');
        tryShowAssignModal();
      }, 1000);
    });
  </script>
</body>
</html>